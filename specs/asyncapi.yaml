asyncapi: '2.6.0'
info:
  title: SWE AI Fleet â€” Event Streams
  version: '0.1.0'
  description: |
    NATS JetStream event contracts for the SWE AI Fleet.
    Domain events follow DDD patterns; each bounded context publishes/consumes via subjects.

defaultContentType: application/json

servers:
  nats:
    url: nats://nats:4222
    protocol: nats
    description: NATS JetStream cluster

channels:
  agile.events:
    description: Domain events from the Agile/Planning bounded context
    subscribe:
      message:
        $ref: '#/components/messages/AgileEvent'

  agent.requests:
    description: Atomic task requests for agent workers (WorkQueue stream)
    publish:
      message:
        $ref: '#/components/messages/AgentRequest'

  agent.responses:
    description: Task completion responses from agent workers
    subscribe:
      message:
        $ref: '#/components/messages/AgentResponse'

  context.updated:
    description: Context change notifications (timeline + graph updates)
    subscribe:
      message:
        $ref: '#/components/messages/ContextUpdated'

  workspace.logs:
    description: Live logs from containerized workspaces (subject pattern workspace.logs.{job_id})
    subscribe:
      message:
        $ref: '#/components/messages/WorkspaceLog'
  task.derivation.requested:
    description: Planning Service publishes derivation requests (Task Derivation subscribes).
    publish:
      message:
        $ref: '#/components/messages/TaskDerivationRequested'
  task.derivation.completed:
    description: Task Derivation publishes success events for Planning / Workflow consumers.
    publish:
      message:
        $ref: '#/components/messages/TaskDerivationCompleted'
  task.derivation.failed:
    description: Task Derivation publishes failure notifications instead of a local DLQ.
    publish:
      message:
        $ref: '#/components/messages/TaskDerivationFailed'

  agent.response.completed:
    description: Agent task completion responses (published by Ray Executor workers)
    subscribe:
      message:
        $ref: '#/components/messages/AgentResponse'
    publish:
      message:
        $ref: '#/components/messages/AgentResponse'

  agent.response.failed:
    description: Agent task failure responses (published by Ray Executor workers)
    subscribe:
      message:
        $ref: '#/components/messages/AgentFailure'
    publish:
      message:
        $ref: '#/components/messages/AgentFailure'

  planning.backlog_review.story.reviewed:
    description: |
      Published by Orchestrator when a backlog review deliberation completes.
      Indicates that all agents have finished reviewing a story for a specific role.
      Consumed by Planning Service to update ceremony status.
    subscribe:
      message:
        $ref: '#/components/messages/BacklogReviewStoryReviewed'
    publish:
      message:
        $ref: '#/components/messages/BacklogReviewStoryReviewed'

  deadletter:
    description: Failed/rejected messages with reason
    subscribe:
      message:
        $ref: '#/components/messages/DeadLetter'

  ceremony.step.executed:
    description: |
      Published by Ceremony Engine when a step execution completes (success or failure).
      Indicates that a step within a ceremony instance has finished executing.
      Consumed by services that need to track ceremony progress.
    publish:
      message:
        $ref: '#/components/messages/CeremonyStepExecuted'

  ceremony.transition.applied:
    description: |
      Published by Ceremony Engine when a state transition is applied to a ceremony instance.
      Indicates that the ceremony has moved from one state to another.
      Consumed by services that need to track ceremony state changes.
    publish:
      message:
        $ref: '#/components/messages/CeremonyTransitionApplied'

components:
  schemas:
    EventBase:
      type: object
      required: [event_id, case_id, ts]
      properties:
        event_id:
          type: string
          format: uuid
          description: Unique event identifier for deduplication
        case_id:
          type: string
          description: Story/case identifier for correlation
        ts:
          type: string
          format: date-time
          description: Event timestamp (ISO 8601)
        producer:
          type: string
          description: Service that produced this event
        trace_id:
          type: string
          description: OpenTelemetry trace ID for distributed tracing

    AgileEventPayload:
      type: object
      required: [event_type]
      properties:
        event_type:
          type: string
          enum: [CASE_CREATED, TRANSITION, SUBTASK_ADDED, HUMAN_APPROVAL, SCORE_UPDATED]
          description: Type of agile lifecycle event
        title:
          type: string
          description: Story title
        from:
          type: string
          description: Previous state (for transitions)
        to:
          type: string
          description: New state (for transitions)
        actor:
          type: string
          description: User or system that triggered the event
        dor_score:
          type: integer
          description: Definition of Ready score (0-100)

    AgentRequestPayload:
      type: object
      required: [agent, phase, task_id, input]
      properties:
        agent:
          type: string
          enum: [DEV, QA, DEVOPS, ARCHITECT]
          description: Agent role/capability
        phase:
          type: string
          enum: [DESIGN, BUILD, TEST, DOCS]
          description: Workflow phase
        task_id:
          type: string
          description: Unique atomic task identifier
        input:
          type: object
          required: [prompt, tools, token_budget]
          properties:
            prompt:
              type: string
              description: Hydrated prompt with context
            tools:
              type: array
              items:
                type: string
              description: Allowed tools for this task
            token_budget:
              type: integer
              description: Maximum tokens for LLM call
            workspace_spec:
              type: object
              description: Optional workspace execution spec
              properties:
                repo:
                  type: object
                  properties:
                    provider: {type: string}
                    owner: {type: string}
                    name: {type: string}
                    ref: {type: string}
                image: {type: string}
                steps:
                  type: array
                  items:
                    type: object
                    properties:
                      name: {type: string}
                      run: {type: string}
                artifacts: {type: array, items: {type: string}}
                timeouts: {type: object, properties: {total_sec: {type: integer}}}

    AgentResponsePayload:
      type: object
      required: [task_id, status]
      properties:
        task_id:
          type: string
          description: Task identifier (correlates with request)
        agent_id:
          type: string
          description: Agent identifier that processed the task
        role:
          type: string
          description: Agent role (ARCHITECT, QA, DEVOPS, etc.)
        status:
          type: string
          enum: [completed, failed]
          description: Execution outcome
        num_agents:
          type: integer
          description: |
            Total number of agents in the deliberation (optional).
            Included when this response is part of a multi-agent deliberation.
            Used by DeliberationResultCollector to determine when deliberation is complete.
        proposal:
          type: object
          description: Agent's proposal/response content
        duration_ms:
          type: integer
          description: Execution duration in milliseconds
        timestamp:
          type: string
          format: date-time
          description: When the response was generated (ISO 8601)
        constraints:
          type: object
          description: |
            Task constraints including metadata (story_id, ceremony_id, etc.).
            Required for task extraction events to correlate with backlog review ceremonies.
          properties:
            story_id:
              type: string
              description: Story identifier (from constraints.story_id)
            plan_id:
              type: string
              description: Plan identifier (optional, for task derivation)
            timeout_seconds:
              type: integer
              description: Task timeout in seconds
            max_retries:
              type: integer
              description: Maximum retry attempts
            metadata:
              type: object
              description: |
                Additional metadata including story_id, ceremony_id, task_type, etc.
                Required for TaskExtractionResultConsumer to process task extraction results.
              properties:
                story_id:
                  type: string
                  description: Story identifier (required for task extraction)
                ceremony_id:
                  type: string
                  description: Ceremony identifier (required for task extraction)
                task_type:
                  type: string
                  description: Task type (e.g., "TASK_EXTRACTION")
                task_id:
                  type: string
                  description: Original task_id from planning (for backlog review)
                num_agents:
                  type: integer
                  description: Number of agents in deliberation
        artifacts:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                description: Artifact type (code, test, doc, etc.)
              uri:
                type: string
                description: Storage URI (s3://, http://, etc.)
        summary:
          type: string
          description: Human-readable outcome summary
        metrics:
          type: object
          properties:
            tokens_in:
              type: integer
            tokens_out:
              type: integer
            latency_ms:
              type: integer
        workspace_report:
          type: object
          description: Workspace execution results
          properties:
            job_id: {type: string}
            commit: {type: string}
            build: {type: object, properties: {ok: {type: boolean}}}
            unit:
              type: object
              properties:
                ok: {type: boolean}
                passed: {type: integer}
                failed: {type: integer}
                coverage: {type: number}
            static:
              type: object
              properties:
                ok: {type: boolean}
                sonar:
                  type: object
                  properties:
                    project_key: {type: string}
                    quality_gate: {type: string}
            e2e:
              type: object
              properties:
                ok: {type: boolean}
                passed: {type: integer}
                failed: {type: integer}
            pr:
              type: object
              properties:
                url: {type: string}
            timings:
              type: object
              properties:
                total_ms: {type: integer}

    ContextUpdatedPayload:
      type: object
      required: [changed]
      properties:
        changed:
          type: array
          items:
            type: string
          description: List of changed entity IDs (task:t-123, decision:d-45, etc.)
        snapshot:
          type: object
          properties:
            version:
              type: integer
              description: Context version number
            hash:
              type: string
              description: Content hash for integrity

    WorkspaceLogPayload:
      type: object
      required: [job_id, line]
      properties:
        job_id:
          type: string
        line:
          type: string
          description: Log line content
        step:
          type: string
          description: Current step name
        level:
          type: string
          enum: [debug, info, warn, error]

    DeadLetterPayload:
      type: object
      required: [topic, reason]
      properties:
        topic:
          type: string
          description: Original subject
        reason:
          type: string
          description: Failure reason
        raw:
          type: object
          description: Original message payload
    TaskDerivationRequestPayload:
      type: object
      required: [plan_id, story_id, requested_by, roles, occurred_at]
      properties:
        plan_id:
          type: string
          description: Plan identifier that needs derivation
        story_id:
          type: string
          description: Story identifier owning the plan
        requested_by:
          type: string
          description: User or service requesting derivation
        roles:
          type: array
          minItems: 1
          items:
            type: string
          description: Ordered list of preferred context roles
        correlation_id:
          type: string
          description: Correlates retries and downstream responses
        context_version:
          type: integer
          description: Optional version of the plan snapshot used to build the request
        occurred_at:
          type: string
          format: date-time
          description: UTC timestamp emitted by Planning Service
    TaskDerivationCompletedPayload:
      type: object
      required: [plan_id, story_id, task_count, status, occurred_at]
      properties:
        plan_id:
          type: string
        story_id:
          type: string
        task_count:
          type: integer
          minimum: 0
        derivation_request_id:
          type: string
          description: Identifier returned by Ray Executor
        status:
          type: string
          enum: [success]
        occurred_at:
          type: string
          format: date-time
          description: UTC timestamp when persistence finished
    TaskDerivationFailedPayload:
      type: object
      required: [plan_id, story_id, status, reason, requires_manual_review, occurred_at]
      properties:
        plan_id:
          type: string
        story_id:
          type: string
        derivation_request_id:
          type: string
          description: Identifier returned by Ray Executor (if available)
        status:
          type: string
          enum: [failed]
        reason:
          type: string
          description: Fail-fast explanation (mapper failure, Ray error, validation, etc.)
        requires_manual_review:
          type: boolean
          description: Whether Planning must mark story as not planned
        occurred_at:
          type: string
          format: date-time
          description: UTC timestamp when the failure was detected

    AgentFailurePayload:
      type: object
      required: [task_id, agent_id, error]
      properties:
        task_id:
          type: string
          description: Task identifier
        agent_id:
          type: string
          description: Agent identifier that failed
        role:
          type: string
          description: Agent role
        error:
          type: string
          description: Error message
        error_type:
          type: string
          description: Type of error (exception class name)
        num_agents:
          type: integer
          description: |
            Total number of agents in the deliberation (optional).
            Included when this failure is part of a multi-agent deliberation.
        duration_ms:
          type: integer
          description: Execution duration before failure
        timestamp:
          type: string
          format: date-time
          description: When the failure occurred (ISO 8601)

    BacklogReviewStoryReviewedPayload:
      type: object
      required: [task_id, status, completed_at]
      properties:
        task_id:
          type: string
          description: |
            Original task identifier (format: "ceremony-{id}:story-{id}:role-{role}").
            May differ from internal deliberation task_id used by orchestrator.
        status:
          type: string
          enum: [completed]
          description: Deliberation status
        results:
          type: array
          items:
            type: object
          description: List of agent response results
        failed_agents:
          type: array
          items:
            type: object
          description: List of failed agent responses (if any)
        total_agents:
          type: integer
          description: Total number of agents in the deliberation
        successful_responses:
          type: integer
          description: Number of successful agent responses
        failed_responses:
          type: integer
          description: Number of failed agent responses
        duration_ms:
          type: integer
          description: Total deliberation duration in milliseconds
        completed_at:
          type: string
          format: date-time
          description: When the deliberation completed (ISO 8601)
        metadata:
          type: object
          description: |
            Additional metadata. May contain original task_id if different from task_id field.
            Used to correlate with backlog review ceremony.

    CeremonyStepExecutedPayload:
      type: object
      required: [instance_id, step_id, status, current_state, output]
      properties:
        instance_id:
          type: string
          description: Ceremony instance identifier (UUID format)
        step_id:
          type: string
          description: Step identifier that was executed
        status:
          type: string
          enum: [COMPLETED, FAILED, CANCELLED]
          description: Step execution status
        current_state:
          type: string
          description: Current state of the ceremony instance after step execution
        output:
          type: object
          description: Step execution output (can be empty dict)
          additionalProperties: true
        error_message:
          type: string
          description: Error message if status is FAILED (optional, only present when status is FAILED)

    CeremonyTransitionAppliedPayload:
      type: object
      required: [instance_id, from_state, to_state, trigger]
      properties:
        instance_id:
          type: string
          description: Ceremony instance identifier (UUID format)
        from_state:
          type: string
          description: Previous state before transition
        to_state:
          type: string
          description: New state after transition
        trigger:
          type: string
          description: Transition trigger that caused the state change

  messages:
    AgileEvent:
      name: AgileEvent
      title: Agile Domain Event
      summary: Lifecycle events from Planning bounded context
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/AgileEventPayload'

    AgentRequest:
      name: AgentRequest
      title: Agent Task Request
      summary: Atomic task assignment for an agent
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/AgentRequestPayload'

    AgentResponse:
      name: AgentResponse
      title: Agent Task Response
      summary: Task completion result from agent worker
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/AgentResponsePayload'

    ContextUpdated:
      name: ContextUpdated
      title: Context Update Event
      summary: Notification of context changes (timeline/graph)
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/ContextUpdatedPayload'

    WorkspaceLog:
      name: WorkspaceLog
      title: Workspace Log Line
      summary: Live log from containerized workspace
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/WorkspaceLogPayload'

    DeadLetter:
      name: DeadLetter
      title: Dead Letter Queue Message
      summary: Failed message with diagnostic info
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/DeadLetterPayload'
    TaskDerivationRequested:
      name: TaskDerivationRequested
      title: Task Derivation Requested
      summary: Planning requests that Task Derivation derive tasks for a plan
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/TaskDerivationRequestPayload'
    TaskDerivationCompleted:
      name: TaskDerivationCompleted
      title: Task Derivation Completed
      summary: Task Derivation persisted derived tasks successfully
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/TaskDerivationCompletedPayload'
    TaskDerivationFailed:
      name: TaskDerivationFailed
      title: Task Derivation Failed
      summary: Task Derivation failed and Planning must mark story as not planned
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/TaskDerivationFailedPayload'

    AgentFailure:
      name: AgentFailure
      title: Agent Task Failure
      summary: Task failure result from agent worker
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/AgentFailurePayload'

    BacklogReviewStoryReviewed:
      name: BacklogReviewStoryReviewed
      title: Backlog Review Story Reviewed
      summary: |
        Published by Orchestrator when all agents complete reviewing a story for a specific role.
        Indicates the deliberation phase is complete and Planning can update the ceremony status.
      payload:
        allOf:
          - $ref: '#/components/schemas/EventBase'
          - $ref: '#/components/schemas/BacklogReviewStoryReviewedPayload'

    CeremonyStepExecuted:
      name: CeremonyStepExecuted
      title: Ceremony Step Executed
      summary: |
        Published by Ceremony Engine when a step execution completes.
        The payload contains step execution results including status, output, and optional error message.
      payload:
        $ref: '#/components/schemas/CeremonyStepExecutedPayload'

    CeremonyTransitionApplied:
      name: CeremonyTransitionApplied
      title: Ceremony Transition Applied
      summary: |
        Published by Ceremony Engine when a state transition is applied to a ceremony instance.
        The payload contains the state change information (from_state, to_state, trigger).
      payload:
        $ref: '#/components/schemas/CeremonyTransitionAppliedPayload'



