syntax = "proto3";

package fleet.planning.v2;

option go_package = "github.com/underpass-ai/swe-ai-fleet/services/planning/gen/fleet/planning/v2;planningv2";

// Planning Service v2 - User Story Management with FSM
//
// Responsibilities:
// - Create and manage user stories
// - FSM state transitions (DRAFT → PO_REVIEW → READY → IN_PROGRESS → DONE)
// - Decision approval/rejection workflow
// - Story lifecycle management

service PlanningService {
  // ========== Project Management (Root of Hierarchy) ==========

  // Create a new project (root of work hierarchy)
  rpc CreateProject(CreateProjectRequest) returns (CreateProjectResponse);

  // Get a project by ID
  rpc GetProject(GetProjectRequest) returns (ProjectResponse);

  // List all projects with optional filtering
  rpc ListProjects(ListProjectsRequest) returns (ListProjectsResponse);

  // ========== Epic Management (Groups Stories) ==========

  // Create a new epic within a project
  rpc CreateEpic(CreateEpicRequest) returns (CreateEpicResponse);

  // Get an epic by ID
  rpc GetEpic(GetEpicRequest) returns (EpicResponse);

  // List epics for a project
  rpc ListEpics(ListEpicsRequest) returns (ListEpicsResponse);

  // ========== Story Management (User Stories) ==========

  // Create a new user story
  rpc CreateStory(CreateStoryRequest) returns (CreateStoryResponse);

  // List stories with optional filtering
  rpc ListStories(ListStoriesRequest) returns (ListStoriesResponse);

  // Transition story to a new state (FSM)
  rpc TransitionStory(TransitionStoryRequest) returns (TransitionStoryResponse);

  // Approve a decision for a story (PO workflow)
  rpc ApproveDecision(ApproveDecisionRequest) returns (ApproveDecisionResponse);

  // Reject a decision for a story (triggers re-deliberation)
  rpc RejectDecision(RejectDecisionRequest) returns (RejectDecisionResponse);

  // Get a single story by ID
  rpc GetStory(GetStoryRequest) returns (Story);

  // ========== Task Management (Atomic Work Items) ==========

  // Create a new task within a story
  rpc CreateTask(CreateTaskRequest) returns (CreateTaskResponse);

  // Get a task by ID
  rpc GetTask(GetTaskRequest) returns (TaskResponse);

  // List tasks for a story
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);

  // ========== Backlog Review Ceremony (Multi-Council Story Review) ==========

  // Create a new backlog review ceremony
  rpc CreateBacklogReviewCeremony(CreateBacklogReviewCeremonyRequest) returns (CreateBacklogReviewCeremonyResponse);

  // Get a backlog review ceremony by ID
  rpc GetBacklogReviewCeremony(GetBacklogReviewCeremonyRequest) returns (BacklogReviewCeremonyResponse);

  // List backlog review ceremonies
  rpc ListBacklogReviewCeremonies(ListBacklogReviewCeremoniesRequest) returns (ListBacklogReviewCeremoniesResponse);

  // Add stories to a ceremony
  rpc AddStoriesToReview(AddStoriesToReviewRequest) returns (AddStoriesToReviewResponse);

  // Remove a story from a ceremony
  rpc RemoveStoryFromReview(RemoveStoryFromReviewRequest) returns (RemoveStoryFromReviewResponse);

  // Start the backlog review ceremony (initiates multi-council reviews)
  rpc StartBacklogReviewCeremony(StartBacklogReviewCeremonyRequest) returns (StartBacklogReviewCeremonyResponse);

  // Approve a review plan (PO approves preliminary plan)
  rpc ApproveReviewPlan(ApproveReviewPlanRequest) returns (ApproveReviewPlanResponse);

  // Reject a review plan (PO rejects preliminary plan)
  rpc RejectReviewPlan(RejectReviewPlanRequest) returns (RejectReviewPlanResponse);

  // Complete the backlog review ceremony
  rpc CompleteBacklogReviewCeremony(CompleteBacklogReviewCeremonyRequest) returns (CompleteBacklogReviewCeremonyResponse);

  // Cancel the backlog review ceremony
  rpc CancelBacklogReviewCeremony(CancelBacklogReviewCeremonyRequest) returns (CancelBacklogReviewCeremonyResponse);
}

// ============================================================================
// HIERARCHY ENTITIES: Project → Epic → Story → Task
// ============================================================================

// Project entity (Root of hierarchy)
message Project {
  string project_id = 1;
  string name = 2;
  string description = 3;
  string status = 4;          // active, planning, in_progress, completed, archived, cancelled
  string owner = 5;           // PO or project owner
  string created_at = 6;      // ISO 8601 timestamp
  string updated_at = 7;      // ISO 8601 timestamp
}

// Epic entity (Groups related stories)
message Epic {
  string epic_id = 1;
  string project_id = 2;      // REQUIRED - parent project (domain invariant)
  string title = 3;
  string description = 4;
  string status = 5;          // active, planning, in_progress, completed, archived, cancelled
  string created_at = 6;      // ISO 8601 timestamp
  string updated_at = 7;      // ISO 8601 timestamp
}

// Story entity
message Story {
  string story_id = 1;
  string epic_id = 2;         // REQUIRED - parent epic (domain invariant)
  string title = 3;
  string brief = 4;
  string state = 5;           // DRAFT, PO_REVIEW, READY_FOR_PLANNING, IN_PROGRESS, etc.
  int32 dor_score = 6;        // Definition of Ready score (0-100)
  string created_by = 7;
  string created_at = 8;      // ISO 8601 timestamp
  string updated_at = 9;      // ISO 8601 timestamp
}

// Task entity
message Task {
  string task_id = 1;
  string story_id = 2;        // REQUIRED - parent story (domain invariant)
  optional string plan_id = 3; // OPTIONAL - link to plan version (can be empty)
  string title = 4;
  string description = 5;
  string type = 6;            // development, feature, refactor, testing, etc. (see TaskType enum)
  string status = 7;          // todo, in_progress, in_review, blocked, completed, cancelled
  string assigned_to = 8;     // Agent or role assigned
  int32 estimated_hours = 9;
  int32 priority = 10;
  string created_at = 11;     // ISO 8601 timestamp
  string updated_at = 12;     // ISO 8601 timestamp
}

// ============================================================================
// PROJECT RPCS
// ============================================================================

// Create Project
message CreateProjectRequest {
  string name = 1;            // REQUIRED - project name
  string description = 2;     // Optional description
  string owner = 3;           // PO or project owner
}

message CreateProjectResponse {
  Project project = 1;
  bool success = 2;
  string message = 3;
}

// Get Project
message GetProjectRequest {
  string project_id = 1;
}

message ProjectResponse {
  Project project = 1;
  bool success = 2;
  string message = 3;
}

// List Projects
message ListProjectsRequest {
  optional string status_filter = 1;  // Filter by status (active, completed, etc.)
  int32 limit = 2;                    // Max results (default 100)
  int32 offset = 3;                   // Pagination offset (default 0)
}

message ListProjectsResponse {
  repeated Project projects = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// ============================================================================
// EPIC RPCS
// ============================================================================

// Create Epic
message CreateEpicRequest {
  string project_id = 1;      // REQUIRED - parent project (domain invariant)
  string title = 2;           // REQUIRED - epic title
  string description = 3;     // Optional description
}

message CreateEpicResponse {
  Epic epic = 1;
  bool success = 2;
  string message = 3;
}

// Get Epic
message GetEpicRequest {
  string epic_id = 1;
}

message EpicResponse {
  Epic epic = 1;
  bool success = 2;
  string message = 3;
}

// List Epics
message ListEpicsRequest {
  optional string project_id = 1;    // Filter by project (optional)
  optional string status_filter = 2; // Filter by status (optional)
  int32 limit = 3;                   // Max results (default 100)
  int32 offset = 4;                  // Pagination offset (default 0)
}

message ListEpicsResponse {
  repeated Epic epics = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// ============================================================================
// STORY RPCS
// ============================================================================

// Create Story
message CreateStoryRequest {
  string epic_id = 1;         // REQUIRED - parent epic (domain invariant)
  string title = 2;           // REQUIRED - story title
  string brief = 3;           // REQUIRED - story description (cannot be empty)
  string created_by = 4;      // User ID or "po"
}

message CreateStoryResponse {
  Story story = 1;
  bool success = 2;
  string message = 3;
}

// List Stories
message ListStoriesRequest {
  optional string state_filter = 1;  // Filter by state (optional)
  int32 limit = 2;                   // Max results (default 100)
  int32 offset = 3;                  // Pagination offset (default 0)
  optional string epic_id = 4;       // Filter by epic (optional)
}

message ListStoriesResponse {
  repeated Story stories = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// Transition Story
message TransitionStoryRequest {
  string story_id = 1;
  string target_state = 2;        // Target FSM state
  string transitioned_by = 3;     // User who triggered transition
}

message TransitionStoryResponse {
  Story story = 1;
  bool success = 2;
  string message = 3;
}

// Approve Decision
message ApproveDecisionRequest {
  string story_id = 1;
  string decision_id = 2;
  string approved_by = 3;         // User ID (typically PO)
  optional string comment = 4;    // Optional approval comment
}

message ApproveDecisionResponse {
  bool success = 1;
  string message = 2;
}

// Reject Decision
message RejectDecisionRequest {
  string story_id = 1;
  string decision_id = 2;
  string rejected_by = 3;         // User ID (typically PO)
  string reason = 4;              // Rejection reason (required)
}

message RejectDecisionResponse {
  bool success = 1;
  string message = 2;
}

// Get Story
message GetStoryRequest {
  string story_id = 1;
}

// ============================================================================
// TASK RPCS
// ============================================================================

// Create Task
message CreateTaskRequest {
  string story_id = 1;        // REQUIRED - parent story (domain invariant)
  optional string plan_id = 2; // OPTIONAL - link to plan version (can be None)
  string title = 3;            // REQUIRED - task title
  string description = 4;      // Optional description
  string type = 5;             // Task type (development, testing, etc.)
  string assigned_to = 6;      // Agent or role to assign
  int32 estimated_hours = 7;   // Estimated effort
  int32 priority = 8;          // Task priority (1 = highest)
}

message CreateTaskResponse {
  Task task = 1;
  bool success = 2;
  string message = 3;
}

// Get Task
message GetTaskRequest {
  string task_id = 1;
}

message TaskResponse {
  Task task = 1;
  bool success = 2;
  string message = 3;
}

// List Tasks
message ListTasksRequest {
  optional string story_id = 1;      // Filter by story (optional)
  optional string status_filter = 2; // Filter by status (optional)
  int32 limit = 3;                   // Max results (default 100)
  int32 offset = 4;                  // Pagination offset (default 0)
}

message ListTasksResponse {
  repeated Task tasks = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// ============================================================================
// BACKLOG REVIEW CEREMONY ENTITIES & RPCS
// ============================================================================

// BacklogReviewCeremony entity
// Coordinates multi-council story reviews (ARCHITECT, QA, DEVOPS)
message BacklogReviewCeremony {
  string ceremony_id = 1;                          // Unique ceremony identifier
  repeated string story_ids = 2;                   // Stories to review
  string status = 3;                               // DRAFT, IN_PROGRESS, REVIEWING, COMPLETED, CANCELLED
  repeated StoryReviewResult review_results = 4;   // Results from council reviews
  string created_by = 5;                           // User who created (typically PO)
  string created_at = 6;                           // ISO 8601 timestamp
  string updated_at = 7;                           // ISO 8601 timestamp
  optional string started_at = 8;                  // When started (if IN_PROGRESS+)
  optional string completed_at = 9;                // When completed (if COMPLETED)
}

// StoryReviewResult - Result of multi-council review for one story
message StoryReviewResult {
  string story_id = 1;                             // Story reviewed
  PlanPreliminary plan_preliminary = 2;            // Generated preliminary plan
  string architect_feedback = 3;                   // ARCHITECT council feedback
  string qa_feedback = 4;                          // QA council feedback
  string devops_feedback = 5;                      // DEVOPS council feedback
  repeated string recommendations = 6;             // Consolidated recommendations
  string approval_status = 7;                      // PENDING, APPROVED, REJECTED
  string reviewed_at = 8;                          // ISO 8601 timestamp
  optional string approved_by = 9;                 // PO who approved (if APPROVED)
  optional string approved_at = 10;                // Approval timestamp
  optional string rejected_by = 11;                // PO who rejected (if REJECTED)
  optional string rejected_at = 12;                // Rejection timestamp
  optional string rejection_reason = 13;           // Why rejected
  
  // PO Approval Context (Semantic - for knowledge graph and context rehydration)
  optional string po_notes = 14;                   // PO explains WHY they approve (REQUIRED if APPROVED)
  optional string po_concerns = 15;                // PO notes risks or things to monitor
  optional string priority_adjustment = 16;        // PO can override priority: HIGH, MEDIUM, LOW
  optional string po_priority_reason = 17;         // WHY priority was adjusted
}

// TaskDecision - Decision metadata for a high-level task
// Explains WHY a task was identified during Backlog Review
message TaskDecision {
  string task_description = 1;                     // Task description (matches tasks_outline)
  string decided_by = 2;                           // Council that identified task (ARCHITECT, QA, DEVOPS)
  string decision_reason = 3;                      // WHY this task is needed (semantic context)
  string council_feedback = 4;                     // Full feedback from council
  int32 task_index = 5;                            // Order in tasks_outline
  string decided_at = 6;                           // ISO 8601 timestamp
}

// PlanPreliminary - Preliminary plan generated during backlog review
message PlanPreliminary {
  string title = 1;                                // Plan title
  string description = 2;                          // Plan description
  repeated string acceptance_criteria = 3;         // Success criteria
  string technical_notes = 4;                      // Technical considerations
  repeated string roles = 5;                       // Roles involved
  string estimated_complexity = 6;                 // LOW, MEDIUM, HIGH
  repeated string dependencies = 7;                // External dependencies
  repeated string tasks_outline = 8;               // High-level tasks identified
  repeated TaskDecision task_decisions = 9;        // Decision context for each task (semantic)
}

// Create Backlog Review Ceremony
message CreateBacklogReviewCeremonyRequest {
  string created_by = 1;                           // REQUIRED - PO creating ceremony
  repeated string story_ids = 2;                   // OPTIONAL - initial stories (can add later)
}

message CreateBacklogReviewCeremonyResponse {
  BacklogReviewCeremony ceremony = 1;
  bool success = 2;
  string message = 3;
}

// Get Backlog Review Ceremony
message GetBacklogReviewCeremonyRequest {
  string ceremony_id = 1;                          // REQUIRED
}

message BacklogReviewCeremonyResponse {
  BacklogReviewCeremony ceremony = 1;
  bool success = 2;
  string message = 3;
}

// List Backlog Review Ceremonies
message ListBacklogReviewCeremoniesRequest {
  optional string status_filter = 1;               // Filter by status
  optional string created_by = 2;                  // Filter by creator
  int32 limit = 3;                                 // Max results (default 100)
  int32 offset = 4;                                // Pagination offset
}

message ListBacklogReviewCeremoniesResponse {
  repeated BacklogReviewCeremony ceremonies = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// Add Stories to Review
message AddStoriesToReviewRequest {
  string ceremony_id = 1;                          // REQUIRED
  repeated string story_ids = 2;                   // REQUIRED - stories to add
}

message AddStoriesToReviewResponse {
  BacklogReviewCeremony ceremony = 1;
  bool success = 2;
  string message = 3;
}

// Remove Story from Review
message RemoveStoryFromReviewRequest {
  string ceremony_id = 1;                          // REQUIRED
  string story_id = 2;                             // REQUIRED - story to remove
}

message RemoveStoryFromReviewResponse {
  BacklogReviewCeremony ceremony = 1;
  bool success = 2;
  string message = 3;
}

// Start Backlog Review Ceremony
// Triggers gRPC calls to Orchestrator (ACK responses)
// Results arrive asynchronously via NATS events
message StartBacklogReviewCeremonyRequest {
  string ceremony_id = 1;                          // REQUIRED
  string started_by = 2;                           // REQUIRED - PO starting ceremony
}

message StartBacklogReviewCeremonyResponse {
  BacklogReviewCeremony ceremony = 1;              // Ceremony in IN_PROGRESS status
  bool success = 2;
  string message = 3;
  int32 total_deliberations_submitted = 4;         // Number of gRPC calls made
}

// Approve Review Plan
message ApproveReviewPlanRequest {
  string ceremony_id = 1;                          // REQUIRED
  string story_id = 2;                             // REQUIRED - story to approve
  string approved_by = 3;                          // REQUIRED - PO approving
  
  // PO Approval Context (REQUIRED for semantic traceability)
  string po_notes = 4;                             // REQUIRED - PO explains WHY they approve
  optional string po_concerns = 5;                 // OPTIONAL - PO notes risks or things to monitor
  optional string priority_adjustment = 6;         // OPTIONAL - HIGH, MEDIUM, LOW
  optional string po_priority_reason = 7;          // REQUIRED if priority_adjustment provided
}

message ApproveReviewPlanResponse {
  BacklogReviewCeremony ceremony = 1;
  string plan_id = 2;                              // Created Plan ID
  bool success = 3;
  string message = 4;
}

// Reject Review Plan
message RejectReviewPlanRequest {
  string ceremony_id = 1;                          // REQUIRED
  string story_id = 2;                             // REQUIRED - story to reject
  string rejected_by = 3;                          // REQUIRED - PO rejecting
  string rejection_reason = 4;                     // REQUIRED - why rejected
}

message RejectReviewPlanResponse {
  BacklogReviewCeremony ceremony = 1;
  bool success = 2;
  string message = 3;
}

// Complete Backlog Review Ceremony
message CompleteBacklogReviewCeremonyRequest {
  string ceremony_id = 1;                          // REQUIRED
  string completed_by = 2;                         // REQUIRED - PO completing
}

message CompleteBacklogReviewCeremonyResponse {
  BacklogReviewCeremony ceremony = 1;
  bool success = 2;
  string message = 3;
}

// Cancel Backlog Review Ceremony
message CancelBacklogReviewCeremonyRequest {
  string ceremony_id = 1;                          // REQUIRED
  string cancelled_by = 2;                         // REQUIRED - PO canceling
}

message CancelBacklogReviewCeremonyResponse {
  BacklogReviewCeremony ceremony = 1;
  bool success = 2;
  string message = 3;
}

