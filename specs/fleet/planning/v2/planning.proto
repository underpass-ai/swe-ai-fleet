syntax = "proto3";

package fleet.planning.v2;

option go_package = "github.com/underpass-ai/swe-ai-fleet/services/planning/gen/fleet/planning/v2;planningv2";

// Planning Service v2 - User Story Management with FSM
//
// Responsibilities:
// - Create and manage user stories
// - FSM state transitions (DRAFT → PO_REVIEW → READY → IN_PROGRESS → DONE)
// - Decision approval/rejection workflow
// - Story lifecycle management

service PlanningService {
  // ========== Project Management (Root of Hierarchy) ==========

  // Create a new project (root of work hierarchy)
  rpc CreateProject(CreateProjectRequest) returns (CreateProjectResponse);

  // Get a project by ID
  rpc GetProject(GetProjectRequest) returns (ProjectResponse);

  // List all projects with optional filtering
  rpc ListProjects(ListProjectsRequest) returns (ListProjectsResponse);

  // ========== Epic Management (Groups Stories) ==========

  // Create a new epic within a project
  rpc CreateEpic(CreateEpicRequest) returns (CreateEpicResponse);

  // Get an epic by ID
  rpc GetEpic(GetEpicRequest) returns (EpicResponse);

  // List epics for a project
  rpc ListEpics(ListEpicsRequest) returns (ListEpicsResponse);

  // ========== Story Management (User Stories) ==========

  // Create a new user story
  rpc CreateStory(CreateStoryRequest) returns (CreateStoryResponse);

  // List stories with optional filtering
  rpc ListStories(ListStoriesRequest) returns (ListStoriesResponse);

  // Transition story to a new state (FSM)
  rpc TransitionStory(TransitionStoryRequest) returns (TransitionStoryResponse);

  // Approve a decision for a story (PO workflow)
  rpc ApproveDecision(ApproveDecisionRequest) returns (ApproveDecisionResponse);

  // Reject a decision for a story (triggers re-deliberation)
  rpc RejectDecision(RejectDecisionRequest) returns (RejectDecisionResponse);

  // Get a single story by ID
  rpc GetStory(GetStoryRequest) returns (Story);

  // ========== Task Management (Atomic Work Items) ==========

  // Create a new task within a story
  rpc CreateTask(CreateTaskRequest) returns (CreateTaskResponse);

  // Get a task by ID
  rpc GetTask(GetTaskRequest) returns (TaskResponse);

  // List tasks for a story
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);
}

// ============================================================================
// HIERARCHY ENTITIES: Project → Epic → Story → Task
// ============================================================================

// Project entity (Root of hierarchy)
message Project {
  string project_id = 1;
  string name = 2;
  string description = 3;
  string status = 4;          // active, planning, in_progress, completed, archived, cancelled
  string owner = 5;           // PO or project owner
  string created_at = 6;      // ISO 8601 timestamp
  string updated_at = 7;      // ISO 8601 timestamp
}

// Epic entity (Groups related stories)
message Epic {
  string epic_id = 1;
  string project_id = 2;      // REQUIRED - parent project (domain invariant)
  string title = 3;
  string description = 4;
  string status = 5;          // active, planning, in_progress, completed, archived, cancelled
  string created_at = 6;      // ISO 8601 timestamp
  string updated_at = 7;      // ISO 8601 timestamp
}

// Story entity
message Story {
  string story_id = 1;
  string epic_id = 2;         // REQUIRED - parent epic (domain invariant)
  string title = 3;
  string brief = 4;
  string state = 5;           // DRAFT, PO_REVIEW, READY_FOR_PLANNING, IN_PROGRESS, etc.
  int32 dor_score = 6;        // Definition of Ready score (0-100)
  string created_by = 7;
  string created_at = 8;      // ISO 8601 timestamp
  string updated_at = 9;      // ISO 8601 timestamp
}

// Task entity
message Task {
  string task_id = 1;
  string story_id = 2;        // REQUIRED - parent story (domain invariant)
  optional string plan_id = 3; // OPTIONAL - link to plan version (can be empty)
  string title = 4;
  string description = 5;
  string type = 6;            // development, feature, refactor, testing, etc. (see TaskType enum)
  string status = 7;          // todo, in_progress, in_review, blocked, completed, cancelled
  string assigned_to = 8;     // Agent or role assigned
  int32 estimated_hours = 9;
  int32 priority = 10;
  string created_at = 11;     // ISO 8601 timestamp
  string updated_at = 12;     // ISO 8601 timestamp
}

// ============================================================================
// PROJECT RPCS
// ============================================================================

// Create Project
message CreateProjectRequest {
  string name = 1;            // REQUIRED - project name
  string description = 2;     // Optional description
  string owner = 3;           // PO or project owner
}

message CreateProjectResponse {
  Project project = 1;
  bool success = 2;
  string message = 3;
}

// Get Project
message GetProjectRequest {
  string project_id = 1;
}

message ProjectResponse {
  Project project = 1;
  bool success = 2;
  string message = 3;
}

// List Projects
message ListProjectsRequest {
  optional string status_filter = 1;  // Filter by status (active, completed, etc.)
  int32 limit = 2;                    // Max results (default 100)
  int32 offset = 3;                   // Pagination offset (default 0)
}

message ListProjectsResponse {
  repeated Project projects = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// ============================================================================
// EPIC RPCS
// ============================================================================

// Create Epic
message CreateEpicRequest {
  string project_id = 1;      // REQUIRED - parent project (domain invariant)
  string title = 2;           // REQUIRED - epic title
  string description = 3;     // Optional description
}

message CreateEpicResponse {
  Epic epic = 1;
  bool success = 2;
  string message = 3;
}

// Get Epic
message GetEpicRequest {
  string epic_id = 1;
}

message EpicResponse {
  Epic epic = 1;
  bool success = 2;
  string message = 3;
}

// List Epics
message ListEpicsRequest {
  optional string project_id = 1;    // Filter by project (optional)
  optional string status_filter = 2; // Filter by status (optional)
  int32 limit = 3;                   // Max results (default 100)
  int32 offset = 4;                  // Pagination offset (default 0)
}

message ListEpicsResponse {
  repeated Epic epics = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// ============================================================================
// STORY RPCS
// ============================================================================

// Create Story
message CreateStoryRequest {
  string epic_id = 1;         // REQUIRED - parent epic (domain invariant)
  string title = 2;           // REQUIRED - story title
  string brief = 3;           // REQUIRED - story description (cannot be empty)
  string created_by = 4;      // User ID or "po"
}

message CreateStoryResponse {
  Story story = 1;
  bool success = 2;
  string message = 3;
}

// List Stories
message ListStoriesRequest {
  optional string state_filter = 1;  // Filter by state (optional)
  int32 limit = 2;                   // Max results (default 100)
  int32 offset = 3;                  // Pagination offset (default 0)
  optional string epic_id = 4;       // Filter by epic (optional)
}

message ListStoriesResponse {
  repeated Story stories = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

// Transition Story
message TransitionStoryRequest {
  string story_id = 1;
  string target_state = 2;        // Target FSM state
  string transitioned_by = 3;     // User who triggered transition
}

message TransitionStoryResponse {
  Story story = 1;
  bool success = 2;
  string message = 3;
}

// Approve Decision
message ApproveDecisionRequest {
  string story_id = 1;
  string decision_id = 2;
  string approved_by = 3;         // User ID (typically PO)
  optional string comment = 4;    // Optional approval comment
}

message ApproveDecisionResponse {
  bool success = 1;
  string message = 2;
}

// Reject Decision
message RejectDecisionRequest {
  string story_id = 1;
  string decision_id = 2;
  string rejected_by = 3;         // User ID (typically PO)
  string reason = 4;              // Rejection reason (required)
}

message RejectDecisionResponse {
  bool success = 1;
  string message = 2;
}

// Get Story
message GetStoryRequest {
  string story_id = 1;
}

// ============================================================================
// TASK RPCS
// ============================================================================

// Create Task
message CreateTaskRequest {
  string story_id = 1;        // REQUIRED - parent story (domain invariant)
  optional string plan_id = 2; // OPTIONAL - link to plan version (can be None)
  string title = 3;            // REQUIRED - task title
  string description = 4;      // Optional description
  string type = 5;             // Task type (development, testing, etc.)
  string assigned_to = 6;      // Agent or role to assign
  int32 estimated_hours = 7;   // Estimated effort
  int32 priority = 8;          // Task priority (1 = highest)
}

message CreateTaskResponse {
  Task task = 1;
  bool success = 2;
  string message = 3;
}

// Get Task
message GetTaskRequest {
  string task_id = 1;
}

message TaskResponse {
  Task task = 1;
  bool success = 2;
  string message = 3;
}

// List Tasks
message ListTasksRequest {
  optional string story_id = 1;      // Filter by story (optional)
  optional string status_filter = 2; // Filter by status (optional)
  int32 limit = 3;                   // Max results (default 100)
  int32 offset = 4;                  // Pagination offset (default 0)
}

message ListTasksResponse {
  repeated Task tasks = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

