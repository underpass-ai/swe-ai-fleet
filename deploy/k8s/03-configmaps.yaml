---
# ConfigMaps for FSM workflow and rigor profiles
# These are mounted by Planning and Workspace services
apiVersion: v1
kind: ConfigMap
metadata:
  name: fleet-config
  namespace: swe-ai-fleet
data:
  # FSM workflow configuration for Planning Service
  # See config/agile.fsm.yaml for the complete configuration
  agile.fsm.yaml: |
    # FSM configuration
    states:
      - id: BACKLOG
        description: Story created but not yet refined
      - id: DRAFT
        description: Story being refined by PO
      - id: DESIGN
        description: Technical design phase
      - id: BUILD
        description: Implementation phase
      - id: TEST
        description: QA testing phase
      - id: DOCS
        description: Documentation phase
      - id: DONE
        description: Story completed and accepted

    transitions:
      - from: BACKLOG
        to: DRAFT
        event: create_story
        guards: []
        description: Initial story creation
      
      - from: DRAFT
        to: DESIGN
        event: approve_scope
        guards: [dor_ok, po_approved]
        description: PO approves story scope after DoR check
      
      - from: DESIGN
        to: BUILD
        event: approve_design
        guards: [po_approved, design_complete]
        description: Technical design approved by PO
      
      - from: BUILD
        to: TEST
        event: build_done
        guards: [all_subtasks_done, builds_passing]
        description: All build tasks complete and passing
      
      - from: TEST
        to: DOCS
        event: qa_passed
        guards: [qa_signoff, tests_passing]
        description: QA approves test results
      
      - from: DOCS
        to: DONE
        event: docs_ready
        guards: [po_approved, docs_complete]
        description: Documentation complete and approved

    human_gates: [approve_scope, approve_design, qa_passed, docs_ready]

    guards:
      dor_ok:
        description: Definition of Ready check passes
        type: automated
        threshold: 75
      po_approved:
        description: Product Owner has explicitly approved
        type: human
        role: PO
      design_complete:
        description: Design artifacts present and reviewed
        type: automated
      all_subtasks_done:
        description: All atomic tasks for this story are complete
        type: automated
      builds_passing:
        description: All workspace builds pass
        type: automated
      qa_signoff:
        description: QA has signed off on test results
        type: human
        role: QA
      tests_passing:
        description: All tests pass with acceptable coverage
        type: automated
      docs_complete:
        description: Documentation artifacts present
        type: automated

    rigor_modifiers:
      L0:
        description: Minimal checks for rapid prototyping
        dor_threshold: 50
      L1:
        description: Standard production quality
        dor_threshold: 75
      L2:
        description: High-quality production
        dor_threshold: 85
      L3:
        description: Mission-critical quality
        dor_threshold: 90

  # Rigor profiles for Workspace Service
  # See config/rigor.yaml for the complete configuration
  rigor.yaml: |
    # Rigor Profiles for Workspace Scoring
    profiles:
      L0:
        name: Experimental
        description: Minimal checks for rapid prototyping
        weights:
          build: 0.40
          unit: 0.30
          static: 0.10
          e2e: 0.10
          coverage: 0.05
          lint: 0.05
        thresholds:
          build: { ok: required }
          unit: { ok: required, pass_rate: 0.70 }
          coverage: { new_code_pct: 50 }
          static: { quality_gate: warn_or_better, max_critical: 999 }
          e2e: { pass_rate: 0.60 }
          lint: { max_errors: 20 }
      
      L1:
        name: Standard Production
        description: Balanced quality for most production features
        weights:
          build: 0.35
          unit: 0.25
          static: 0.20
          e2e: 0.10
          coverage: 0.05
          lint: 0.05
        thresholds:
          build: { ok: required }
          unit: { ok: required, pass_rate: 0.95 }
          coverage: { new_code_pct: 70 }
          static: { quality_gate: ok, max_critical: 5, max_major: 20 }
          e2e: { pass_rate: 0.85 }
          lint: { max_errors: 5 }
      
      L2:
        name: High Quality
        description: High standards for sensitive production features
        weights:
          build: 0.30
          unit: 0.25
          static: 0.25
          e2e: 0.12
          coverage: 0.05
          lint: 0.03
        thresholds:
          build: { ok: required }
          unit: { ok: required, pass_rate: 0.98 }
          coverage: { new_code_pct: 80 }
          static: { quality_gate: ok, max_critical: 2, max_major: 10 }
          e2e: { pass_rate: 0.95 }
          lint: { max_errors: 2 }
      
      L3:
        name: Mission Critical
        description: Maximum rigor for security-critical features
        weights:
          build: 0.25
          unit: 0.25
          static: 0.30
          e2e: 0.15
          coverage: 0.03
          lint: 0.02
        thresholds:
          build: { ok: required }
          unit: { ok: required, pass_rate: 1.0 }
          coverage: { new_code_pct: 90 }
          static: { quality_gate: ok, max_critical: 0, max_major: 5 }
          e2e: { pass_rate: 1.0 }
          lint: { max_errors: 0 }

    gating_thresholds:
      pass: 90
      warn: 70
      block: 0