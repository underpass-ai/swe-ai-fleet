# Task Derivation Configuration
# Loaded by Planning Service for LLM-based task decomposition

version: "1.0"
description: "Configuration for automatic task derivation from approved plans"

# LLM Generation Settings
llm:
  model: "Qwen/Qwen2.5-7B-Instruct"
  temperature: 0.3  # Low for structured output
  max_tokens: 2048
  timeout_seconds: 120

# Task Derivation Constraints
constraints:
  min_tasks: 3
  max_tasks: 8
  max_estimated_hours_per_task: 40
  priority_range:
    min: 1
    max: 10

# Retry Strategy (circular dependencies)
retry:
  max_retries: 3
  backoff_seconds: 5
  human_review_after_max: true

# LLM Prompt Template
prompt_template: |
  # Task Derivation

  Decompose the following software development plan into atomic, executable tasks.

  ## Context (Rehydrated by Role)
  {rehydrated_context}

  ## Plan Description
  {description}

  ## Acceptance Criteria
  {acceptance_criteria}

  ## Technical Notes
  {technical_notes}

  ## Instructions
  For each task, provide:
  1. **TITLE**: Brief task title (max 80 chars)
  2. **DESCRIPTION**: Detailed task description
  3. **ESTIMATED_HOURS**: Estimated hours (integer, 1-40)
  4. **PRIORITY**: Priority 1-10 (1 = highest)
  5. **KEYWORDS**: Key technical concepts (comma-separated, 2-5 keywords)

  Note: Do NOT include TASK_ID - Planning Service generates task IDs automatically.
  Note: Do NOT include ROLE - Planning Service assigns roles based on RBAC and event context.

  ## Output Format (STRICT - Follow EXACTLY)

  CRITICAL: You MUST output tasks in this EXACT format. Do NOT deviate from this structure.

  Format rules:
  - Each task MUST start with TITLE: on a new line
  - Fields MUST appear in this exact order: TITLE, DESCRIPTION, ESTIMATED_HOURS, PRIORITY, KEYWORDS
  - Do NOT include TASK_ID - Planning Service generates task IDs automatically
  - Do NOT include ROLE - Planning Service assigns roles based on RBAC and event context
  - Each field MUST be on a single line (no multiline values)
  - Field names MUST be uppercase with underscore: TITLE, ESTIMATED_HOURS, PRIORITY (not Title or Estimated_Hours)
  - Field values MUST follow the colon and space: "FIELD_NAME: value"
  - Separate multiple tasks with exactly "---" on its own line
  - Do NOT include any other text, explanations, or markdown formatting
  - Do NOT use markdown code blocks (```)

  Example format (copy this structure exactly):

  TITLE: Setup project structure
  DESCRIPTION: Initialize repository with standard directory layout and configuration files
  ESTIMATED_HOURS: 8
  PRIORITY: 1
  KEYWORDS: setup, repository, structure
  ---
  TITLE: Create database schema
  DESCRIPTION: Design and implement database tables with proper relationships
  ESTIMATED_HOURS: 16
  PRIORITY: 2
  KEYWORDS: database, schema, tables

  IMPORTANT:
  - Derive {min_tasks}-{max_tasks} atomic tasks
  - Each task should be completable in 1-2 days
  - Keywords should be technical concepts (for dependency detection)
  - Avoid circular dependencies (if A needs B, B cannot need A)
  - Be specific and actionable
  - Follow the format EXACTLY - any deviation will cause parsing errors

  Output tasks now (use the format above):

# Example output for validation (matches strict format)
example_output: |
  TITLE: Setup authentication infrastructure
  DESCRIPTION: Create JWT token service with secret management
  ESTIMATED_HOURS: 8
  PRIORITY: 1
  KEYWORDS: jwt, authentication, token
  ---
  TITLE: Implement login endpoint
  DESCRIPTION: Create POST /auth/login with JWT token generation
  ESTIMATED_HOURS: 16
  PRIORITY: 2
  KEYWORDS: endpoint, login, jwt

