# syntax=docker/dockerfile:1
# E2E Architecture Test Runner
# Generates gRPC stubs during build and runs architecture validation test

FROM python:3.13-slim

WORKDIR /workspace

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY pyproject.toml ./

# Install Python dependencies
RUN pip install --no-cache-dir -e ".[grpc,dev]"

# Copy proto specs
COPY specs/ /workspace/specs/

# Generate gRPC stubs during build (NOT at runtime)
RUN mkdir -p services/orchestrator/gen services/context/gen && \
    python -m grpc_tools.protoc \
        --python_out=services/orchestrator/gen \
        --grpc_python_out=services/orchestrator/gen \
        --proto_path=specs/fleet/orchestrator/v1 \
        specs/fleet/orchestrator/v1/orchestrator.proto && \
    sed -i 's/^import orchestrator_pb2/from . import orchestrator_pb2/' \
        services/orchestrator/gen/orchestrator_pb2_grpc.py && \
    echo "__all__ = ['orchestrator_pb2', 'orchestrator_pb2_grpc']" > \
        services/orchestrator/gen/__init__.py && \
    python -m grpc_tools.protoc \
        --python_out=services/context/gen \
        --grpc_python_out=services/context/gen \
        --proto_path=specs/fleet/context/v1 \
        specs/fleet/context/v1/context.proto && \
    sed -i 's/^import context_pb2/from . import context_pb2/' \
        services/context/gen/context_pb2_grpc.py && \
    echo "__all__ = ['context_pb2', 'context_pb2_grpc']" > \
        services/context/gen/__init__.py

# Copy test file
COPY tests/e2e/test_architecture_e2e.py /workspace/tests/e2e/

# Set PYTHONPATH
ENV PYTHONPATH=/workspace

# Run test
CMD ["pytest", "tests/e2e/test_architecture_e2e.py::test_full_architecture_deliberation", "-v", "-s", "--tb=short", "--no-header"]

