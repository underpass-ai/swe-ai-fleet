# Backlog Review Flow

**This is the designed source of the truth by owner Tirso Garcia**

```mermaid
%%{init: {'theme': 'base', 'themeVariables': {'background': '#1a1a1a', 'primaryColor': '#f9f9f9', 'primaryTextColor': '#333333', 'primaryBorderColor': '#cccccc', 'lineColor': '#333333', 'secondaryColor': '#f4f4f4', 'tertiaryColor': '#ffffff', 'subgraphBg': '#2a2a2a', 'subgraphBorder': '#888888', 'subgraphText': '#ffffff'}}}%%
flowchart LR
    subgraph MAIN_FLOW["Backlog Review Flow"]
        style MAIN_FLOW fill:#2a2a2a,stroke:#888888,stroke-width:3px,color:#ffffff
        UI(("Planning UI"))
        PL(("Planning Service"))
        DB(("Persistence Repository<br/>(Projects/Epics/Histories...)"))
        CTX_REPO(("Context Rehydration<br/>Repository"))
        CTX(("Context Service"))
        EXEC(("Ray Executor Service"))
        BRP(("Backlog Review Processor"))

        subgraph DELIBERATION_EXEC["Deliberation Execution"]
            RAYJOB(("Ray Job"))
            VLLM(("vLLM Service"))
        end
        style DELIBERATION_EXEC fill:#2a2a2a,stroke:#888888,stroke-width:2px,color:#ffffff

        subgraph TASK_CREATION_EXEC["Task Creation Execution"]
            RAYJOB_TASK(("Ray Job"))
            VLLM_TASK(("vLLM Service"))
        end
        style TASK_CREATION_EXEC fill:#2a2a2a,stroke:#888888,stroke-width:2px,color:#ffffff

        UI <-->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#DD7A00 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>1</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Get node relations</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>(Projects→Epics→Stories→Tasks)</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| PL
        PL <-->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#DD7A00 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>1.1</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>Repository</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| DB
        UI -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>2</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Deliberation request</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>or list of stories</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| PL
        PL -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>3</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Get context rehydration</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>by RBAC and StoryId</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| CTX
        CTX <-->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#DD7A00 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>3.1</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>Repository</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>context rehydration</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>by RBAC/StoryId</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| CTX_REPO
        PL -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>4</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Trigger deliberation</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>per RBAC agent and StoryId</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| EXEC
        EXEC -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>5</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>RAY</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Create Ray job</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| RAYJOB
        RAYJOB -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>6</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>REST</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Model invocation (OpenAI)</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>for rehydrated context</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| VLLM
        VLLM -.->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>7</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>NATS</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>VLLM response</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>StoryID, DeliberationId</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| BRP
        BRP -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>8</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Save deliberation response</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| CTX
        CTX <-->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#DD7A00 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>8.1</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>Save deliberations</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| CTX_REPO
        BRP --> |"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#FF4444 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>9</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='background:#4a0000; padding:2px 8px; border-radius:3px; font-size:0.9em; font-weight:bold; color:#FFFFFF !important; display:block;'>DELIBERATIONS<br/>COMPLETED</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| PL
        PL -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#FF4444 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>9.1</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC/WebSocket</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Notify deliberations completed</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| UI
        BRP --> |"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#FF4444 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>10</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Trigger task creation</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>to TASK CREATOR agent and StoryId</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| EXEC
        EXEC -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>11</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>RAY</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Create Ray job</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| RAYJOB_TASK
        RAYJOB_TASK -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>12</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>REST</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Model invocation (OpenAI)</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>with all deliberations</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| VLLM_TASK

        subgraph TASK_SAVING_LOOP["Task Saving Loop (N times - one per task)"]
            direction LR
            VLLM_TASK -.->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>13</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>NATS</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>VLLM response</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>TaskId, StoryID (N events)</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| BRP
            BRP -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#00AAFF !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>13.1</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Save TASK response</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>(N times)</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| CTX
        end
        style TASK_SAVING_LOOP fill:#2a2a2a,stroke:#888888,stroke-width:2px,color:#ffffff

        BRP -.->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#FF4444 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>14</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>NATS</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='background:#4a0000; padding:2px 8px; border-radius:3px; font-size:0.9em; font-weight:bold; color:#FFFFFF !important; display:block;'>ALL TASK CREATED</span><span style='font-size:0.8em; color:#E0E0E0 !important; display:block;'>(after all N tasks saved)</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| PL
        PL -->|"<div style='position:relative; z-index:10; display:block; background:#404040 !important; padding:0; margin:0; line-height:normal;'><table style='width:100%; border-collapse:collapse; background:#404040 !important; opacity:1 !important; padding:8px 6px 10px 6px; border-radius:4px 4px 0 0; border:2px solid #666; border-bottom:none; box-shadow:0 0 8px rgba(0,0,0,0.8), 0 2px 0 0 #404040; margin:0; border-spacing:0;'><tr><td style='text-align:left; vertical-align:top; padding:0; background:#404040 !important;'><span style='font-size:1.6em; font-weight:bold; color:#FF4444 !important; background:#2a2a2a; padding:2px 6px; border-radius:4px;'>14.1</span></td><td style='text-align:right; vertical-align:top; padding:0 8px 0 0; background:#404040 !important;'><span style='background:#555; padding:2px 6px; border-radius:3px; font-size:0.85em; color:#FFFFFF !important; font-weight:bold;'>gRPC/WebSocket</span></td></tr><tr><td colspan='2' style='text-align:left; padding-top:4px; padding-bottom:0; background:#404040 !important;'><span style='font-size:0.9em; color:#FFFFFF !important; font-weight:500; display:block;'>Notify all tasks created</span></td></tr></table><div style='width:100%; height:4px; background:#404040 !important; border-radius:0 0 4px 4px; border:2px solid #666; border-top:none; margin-top:-2px; box-shadow:0 2px 0 0 #404040;'></div></div>"| UI
    end

    %% Estilos de colores
    %% Bidireccionales: Naranja oscurecido (#DD7A00)
    linkStyle 0 stroke:#DD7A00,stroke-width:4px,stroke-opacity:1
    linkStyle 1 stroke:#DD7A00,stroke-width:4px,stroke-opacity:1
    linkStyle 4 stroke:#DD7A00,stroke-width:4px,stroke-opacity:1
    linkStyle 10 stroke:#DD7A00,stroke-width:4px,stroke-opacity:1
    %% De ida: Azul oscurecido (#0055DD)
    linkStyle 2 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 3 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 5 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 6 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 7 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 8 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 14 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 15 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 16 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    linkStyle 17 stroke:#0055DD,stroke-width:4px,stroke-opacity:1
    %% De vuelta: Rojo oscurecido (#DD0000)
    linkStyle 11 stroke:#DD0000,stroke-width:4px,stroke-opacity:1
    linkStyle 12 stroke:#DD0000,stroke-width:4px,stroke-opacity:1
    linkStyle 13 stroke:#DD0000,stroke-width:4px,stroke-opacity:1
    linkStyle 18 stroke:#DD0000,stroke-width:4px,stroke-opacity:1
    linkStyle 19 stroke:#DD0000,stroke-width:4px,stroke-opacity:1



```

### Color Legend

- **Blue lines**: Forward arrows
- **Red lines**: Return arrows
- **Orange lines**: Bidirectional arrows
