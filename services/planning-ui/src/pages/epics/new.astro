---
import BaseLayout from '../../layouts/BaseLayout.astro';

const projectId = Astro.url.searchParams.get('project_id') || '';
---

<BaseLayout title="New Epic">
  <div class="max-w-2xl mx-auto">
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-900">Create New Epic</h2>
      <p class="mt-1 text-sm text-gray-600">
        Create a new epic to group related stories
      </p>
    </div>

    <!-- Error Alert (hidden by default) -->
    <div
      id="error-alert"
      class="hidden mb-6 bg-red-50 border border-red-200 rounded-md p-4"
      role="alert"
    >
      <div class="flex">
        <div class="flex-shrink-0">
          <svg
            class="h-5 w-5 text-red-400"
            fill="currentColor"
            viewBox="0 0 20 20"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd"
            />
          </svg>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-sm font-medium text-red-800">Error creating epic</h3>
          <div class="mt-2 text-sm text-red-700">
            <p id="error-message"></p>
          </div>
        </div>
        <div class="ml-auto pl-3">
          <button
            type="button"
            id="error-dismiss"
            class="inline-flex text-red-400 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
            aria-label="Dismiss"
          >
            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <form
      action="/api/epics"
      method="POST"
      class="bg-white shadow rounded-lg p-6 space-y-6"
      id="create-epic-form"
    >
      {projectId && (
        <input type="hidden" name="project_id" value={projectId} />
      )}

      {!projectId && (
        <div>
          <label for="project_id" class="block text-sm font-medium text-gray-700">
            Project <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="project_id"
            id="project_id"
            required
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            placeholder="project-id"
          />
        </div>
      )}

      <div>
        <label for="title" class="block text-sm font-medium text-gray-700">
          Epic Title <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          name="title"
          id="title"
          required
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
          placeholder="Epic Title"
        />
      </div>

      <div>
        <label for="description" class="block text-sm font-medium text-gray-700">
          Description
        </label>
        <textarea
          name="description"
          id="description"
          rows="4"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
          placeholder="Describe the epic goals and scope..."
        ></textarea>
      </div>

      <div class="flex justify-end space-x-3">
        <a
          href={projectId ? `/projects/${projectId}` : '/epics'}
          class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
        >
          Cancel
        </a>
        <button
          type="submit"
          id="submit-button"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="submit-text">Create Epic</span>
          <svg
            id="submit-spinner"
            class="hidden ml-2 h-4 w-4 animate-spin text-white"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </button>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const form = document.getElementById('create-epic-form') as HTMLFormElement;
      const errorAlert = document.getElementById('error-alert') as HTMLElement;
      const errorMessage = document.getElementById('error-message') as HTMLElement;
      const errorDismiss = document.getElementById('error-dismiss') as HTMLButtonElement;
      const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
      const submitText = document.getElementById('submit-text') as HTMLElement;
      const submitSpinner = document.getElementById('submit-spinner') as HTMLElement;

      function showError(message: string) {
        errorMessage.textContent = message;
        errorAlert.classList.remove('hidden');
        errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      function hideError() {
        errorAlert.classList.add('hidden');
      }

      function setLoading(loading: boolean) {
        submitButton.disabled = loading;
        if (loading) {
          submitText.textContent = 'Creating...';
          submitSpinner.classList.remove('hidden');
        } else {
          submitText.textContent = 'Create Epic';
          submitSpinner.classList.add('hidden');
        }
      }

      errorDismiss?.addEventListener('click', hideError);

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        setLoading(true);

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          const response = await fetch('/api/epics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            const result = await response.json();
            const projectId = data.project_id as string;
            submitText.textContent = 'âœ“ Epic created!';
            setTimeout(() => {
              window.location.href = projectId
                ? `/projects/${projectId}`
                : `/epics/${result.epic.epic_id}`;
            }, 500);
          } else {
            const errorData = await response.json();
            const errorMsg =
              errorData.message ||
              `Failed to create epic (${response.status} ${response.statusText})`;
            showError(errorMsg);
            setLoading(false);
          }
        } catch (err) {
          const errorMsg =
            err instanceof Error
              ? err.message
              : 'Network error: Unable to connect to the server';
          showError(errorMsg);
          setLoading(false);
        }
      });
    })();
  </script>
</BaseLayout>


