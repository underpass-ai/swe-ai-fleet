name: CI - Modular Build and Test

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
  push:
    branches:
      - '**'

jobs:
  # Build and test each module independently
  test-module:
    name: Test ${{ matrix.module }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Core modules (tested individually)
          - module: core/shared
            python-version: '3.13'
          - module: core/memory
            python-version: '3.13'
          - module: core/context
            python-version: '3.13'
          - module: core/orchestrator
            python-version: '3.13'
          - module: core/agents_and_tools
            python-version: '3.13'
          - module: core/ray_jobs
            python-version: '3.11'
          - module: core/reports
            python-version: '3.13'
          # Service modules
          - module: services/backlog_review_processor
            python-version: '3.13'
          - module: services/context
            python-version: '3.13'
          - module: services/orchestrator
            python-version: '3.13'
          - module: services/planning
            python-version: '3.13'
          - module: services/ray_executor
            python-version: '3.11'
          - module: services/task_derivation
            python-version: '3.13'
          - module: services/workflow
            python-version: '3.13'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # Select constraints based on Python version.
          if [ "${{ matrix.python-version }}" = "3.11" ]; then
            CONSTRAINTS="constraints-py311.txt"
          else
            CONSTRAINTS="constraints.txt"
          fi

          # Install root project dev dependencies (best-effort; root requires Python >= 3.13).
          pip install -c "$CONSTRAINTS" -e ".[dev]" || echo "ℹ️  Root package not installable for this Python, continuing..."

          # Install only the compatible modules for the interpreter (script is Python-aware).
          ./scripts/install-modules.sh

      - name: Generate protobuf files (if needed)
        if: contains(matrix.module, 'services/') || contains(matrix.module, 'core/context') || contains(matrix.module, 'core/orchestrator')
        run: |
          if [ -f "${{ matrix.module }}/generate-protos.sh" ]; then
            if [ "${{ matrix.python-version }}" = "3.11" ]; then
              CONSTRAINTS="constraints-py311.txt"
            else
              CONSTRAINTS="constraints.txt"
            fi
            pip install -c "$CONSTRAINTS" grpcio-tools
            bash "${{ matrix.module }}/generate-protos.sh"
          fi

      - name: Run tests for module
        run: |
          ./scripts/test-module.sh ${{ matrix.module }} --cov-report=xml --cov-report=json

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.module }}-${{ matrix.python-version }}
          path: |
            ${{ matrix.module }}/coverage.xml
            ${{ matrix.module }}/coverage.json
          retention-days: 1

  # Combine coverage reports
  combine-coverage:
    name: Combine Coverage Reports
    runs-on: ubuntu-latest
    needs: test-module
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports

      - name: Combine coverage reports
        run: |
          pip install coverage
          # Combine all coverage.xml files into a single report
          # Find all coverage.xml files recursively (artifacts preserve directory structure)
          find coverage-reports -name "coverage.xml" -exec coverage combine {} + || true
          coverage xml -o coverage.xml || echo "No coverage data to combine"

      - name: Upload combined coverage
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: coverage.xml
          retention-days: 1

  # UI Tests (independent)
  ui-tests:
    name: Unit Tests (UI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/planning-ui/package-lock.json

      - name: Install UI dependencies
        working-directory: services/planning-ui
        run: npm ci

      - name: Generate gRPC code from protobuf
        working-directory: services/planning-ui
        run: npm run generate-grpc

      - name: Run UI tests with coverage
        working-directory: services/planning-ui
        run: npm run test:coverage

      - name: Upload UI coverage
        uses: actions/upload-artifact@v4
        with:
          name: ui-coverage
          path: services/planning-ui/coverage/lcov.info
          retention-days: 1

  # SonarCloud Analysis
  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [combine-coverage, ui-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Python coverage
        uses: actions/download-artifact@v4
        with:
          name: python-coverage
          path: .

      - name: Download UI coverage
        uses: actions/download-artifact@v4
        with:
          name: ui-coverage
          path: services/planning-ui/coverage/

      - name: SonarCloud Scan (Pull Request)
        if: github.event_name == 'pull_request'
        uses: sonarsource/sonarcloud-github-action@v3.1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: ${{ github.workspace }}
          args: >
            -Dsonar.organization=underpass-ai-swe-ai-fleet
            -Dsonar.projectKey=underpass-ai-swe-ai-fleet
            -Dsonar.pullrequest.key=${{ github.event.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.javascript.lcov.reportPaths=services/planning-ui/coverage/lcov.info
            -Dsonar.typescript.lcov.reportPaths=services/planning-ui/coverage/lcov.info
            -Dsonar.scanner.image=sonarsource/sonar-scanner-cli:11.1

      - name: SonarCloud Scan (Main Branch)
        if: >
          github.event_name == 'push' &&
          github.ref_name == 'main'
        uses: sonarsource/sonarcloud-github-action@v3.1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: ${{ github.workspace }}
          args: >
            -Dsonar.organization=underpass-ai-swe-ai-fleet
            -Dsonar.projectKey=underpass-ai-swe-ai-fleet
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.javascript.lcov.reportPaths=services/planning-ui/coverage/lcov.info
            -Dsonar.typescript.lcov.reportPaths=services/planning-ui/coverage/lcov.info
            -Dsonar.scanner.image=sonarsource/sonar-scanner-cli:11.1

