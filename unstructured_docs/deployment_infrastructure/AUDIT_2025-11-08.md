# AuditorÃ­a del Directorio deploy/ - 2025-11-08

## Executive Summary

**Estado actual**: ğŸ”´ **CAÃ“TICO** - Requiere reorganizaciÃ³n urgente

- **43 archivos YAML** en `deploy/k8s/` con numeraciÃ³n inconsistente
- **2 registry namespaces** mezclados (`swe-fleet` vs `swe-ai-fleet`)
- **12 archivos grpcui** dispersos (14a-14f con letras)
- **Servicios sin numeraciÃ³n** coherente (gaps, duplicaciones)
- **Archivos obsoletos** mezclados con producciÃ³n

---

## ğŸ“Š MÃ©tricas Clave

| MÃ©trica | Valor | Estado |
|---------|-------|--------|
| Archivos K8s YAML | 43 | ğŸŸ¡ Demasiados |
| Deployments | 16 | âœ… OK |
| Services | ~25 | âœ… OK |
| Jobs | 5 | âœ… OK |
| StatefulSets | 3 (NATS, Neo4j, Valkey) | âœ… OK |
| Ingresses | ~10 | ğŸŸ¡ Muchos |
| Registry namespaces | 2 diferentes | ğŸ”´ **CRÃTICO** |
| Archivos sin numeraciÃ³n | 1 (vllm-server.yaml) | ğŸŸ¡ Inconsistente |

---

## ğŸ”´ **PROBLEMAS CRÃTICOS**

### 1. Registry Namespace Inconsistency (BLOQUEANTE)

**Problema**: Dos namespaces mezclados sin patrÃ³n claro

```
registry.underpassai.com/swe-fleet/          â† 13 imÃ¡genes (mayorÃ­a)
registry.underpassai.com/swe-ai-fleet/       â† 3 imÃ¡genes (minorÃ­a)
```

**Servicios en swe-fleet** (mayorÃ­a):
- context, orchestrator, planning, monitoring
- ray-executor, grpcui-server, proto-docs-server
- workspace, storycoach, ui

**Servicios en swe-ai-fleet** (minorÃ­a):
- workflow (Ãºnico microservicio)
- orchestrator-jobs, nats-jobs (jobs auxiliares)

**Impacto**:
- Script `fresh-redeploy.sh` construye en `swe-ai-fleet`
- Pero YAMLs esperan `swe-fleet` â†’ **rollback manual rompe cluster**

**RecomendaciÃ³n**: **UNIFICAR A `swe-ai-fleet`** (align with K8s namespace)

---

### 2. NumeraciÃ³n CaÃ³tica

**Problema**: Sistema de numeraciÃ³n inconsistente e ilÃ³gico

```
00-namespace.yaml          âœ… LÃ³gico (primero)
00-configmaps.yaml         âœ… LÃ³gico
01-nats.yaml              âœ… LÃ³gico
01-secrets.yaml           âš ï¸  Duplica prefijo 01
02a-nats-delete-streams   âš ï¸  Usa letra 'a'
02-nats-internal-dns      âœ… OK
03-configmaps.yaml        âŒ Duplica 00-configmaps (obsoleto?)
04-services.yaml          âŒ 4 deployments mezclados (planning, storycoach, workspace, ui)
...
14a-grpcui-deployment     âŒ 12 archivos grpcui con 14a-14f (caÃ³tico)
...
30-grafana.yaml           âš ï¸  Gap enorme (15 â†’ 30)
vllm-server.yaml          âŒ Sin numeraciÃ³n
```

**Consecuencias**:
1. Imposible saber orden de aplicaciÃ³n correcto
2. Gaps misteriosos (16-29 no existen)
3. Archivos grpcui dispersos (14a-f)
4. Servicios mezclados en `04-services.yaml`

---

### 3. Archivo Frankenstein: `04-services.yaml`

**Contenido**: 4 deployments + 4 services **no relacionados** en un solo archivo

```yaml
# 04-services.yaml contiene:
- Service + Deployment: planning
- Service + Deployment: storycoach
- Service + Deployment: workspace
- Service + Deployment: ui (po-ui)
```

**Problemas**:
- Viola principio de un servicio por archivo
- Impossible hacer rollout selectivo
- Confuso para nuevos developers
- **Â¿EstÃ¡n estos servicios en producciÃ³n?** (no aparecen en `kubectl get pods`)

---

### 4. GrpcUI: 12 Archivos Dispersos

**Problema**: GrpcUI debug tool tiene 12 archivos con prefijos ilÃ³gicos

```
14a-grpcui-deployment.yaml            â† "genÃ©rico"
14b-grpcui-service.yaml
14c-grpcui-ingress.yaml
14d-grpcui-context-deployment.yaml    â† por servicio
14d-grpcui-orchestrator-deployment.yaml
14d-grpcui-ray_executor-deployment.yaml
14e-grpcui-context-service.yaml
14e-grpcui-orchestrator-service.yaml
14e-grpcui-ray_executor-service.yaml
14f-grpcui-context-ingress.yaml
14f-grpcui-orchestrator-ingress.yaml
14f-grpcui-ray_executor-ingress.yaml
```

**ConfusiÃ³n**:
- Â¿Es `14a` el genÃ©rico o es para otro servicio?
- Letras `a,b,c,d,e,f` no comunican intent
- DeberÃ­an estar en subdirectorio `grpcui/`

---

### 5. Secrets: `07-neo4j-secret.yaml` Obsoleto?

**Conflicto**:
- Existe `07-neo4j-secret.yaml` (separado)
- Existe `01-secrets.yaml` (con neo4j-auth)

**Â¿Duplicado?** Necesita verificaciÃ³n

---

### 6. ConfigMaps Duplicados

**Conflicto**:
- `00-configmaps.yaml` (app-config, service-urls)
- `03-configmaps.yaml` (Â¿quÃ© contiene?)

---

## ğŸ“‹ **INVENTARIO COMPLETO**

### Namespace & Config (00-03)

| Archivo | Recursos | PropÃ³sito | Estado |
|---------|----------|-----------|--------|
| `00-namespace.yaml` | Namespace | Crea `swe-ai-fleet` | âœ… Necesario |
| `00-configmaps.yaml` | 2 ConfigMaps | app-config, service-urls | âœ… Necesario |
| `01-nats.yaml` | StatefulSet + Service | NATS JetStream | âœ… CrÃ­tico |
| `01-secrets.yaml` | 3 Secrets | neo4j, hf-token, grafana | âœ… Necesario (reciÃ©n creado) |
| `02a-nats-delete-streams.yaml` | Job | Limpia NATS streams | âš ï¸  Utility |
| `02-nats-internal-dns.yaml` | 5 Services | DNS interno para NATS | âœ… Necesario |
| `03-configmaps.yaml` | ConfigMap | â“ Verificar contenido | âš ï¸  Posible duplicado |

### Services Consolidados (04)

| Archivo | Recursos | PropÃ³sito | Estado |
|---------|----------|-----------|--------|
| `04-services.yaml` | 4 Deployments + Services | planning, storycoach, workspace, po-ui | âŒ **Frankenstein file** |

**AnÃ¡lisis**:
- `planning` â†’ Ya existe en `12-planning-service.yaml` âŒ DUPLICADO
- `storycoach` â†’ **Â¿En producciÃ³n?** (no en fresh-redeploy.sh)
- `workspace` â†’ **Â¿En producciÃ³n?** (no en fresh-redeploy.sh)
- `po-ui` â†’ **Â¿En producciÃ³n?** (deployado pero viejo)

---

### Ingresses (05-06)

| Archivo | Recursos | PropÃ³sito | Estado |
|---------|----------|-----------|--------|
| `05-ui-ingress.yaml` | Ingress | Expose PO-UI | âœ… Necesario |
| `06-ray-dashboard-ingress.yaml` | Service + Ingress | Ray dashboard | âœ… Necesario |

---

### Infrastructure (07-10)

| Archivo | Recursos | PropÃ³sito | Estado |
|---------|----------|-----------|--------|
| `07-neo4j-secret.yaml` | Secret | Neo4j auth | âš ï¸  Duplica 01-secrets? |
| `07-registry.yaml` | Namespace + Deployment + Service + Ingress | Container registry interno | âœ… Necesario |
| `09-neo4j.yaml` | StatefulSet + 2 Services | Neo4j database | âœ… CrÃ­tico |
| `10-valkey.yaml` | StatefulSet + 3 Services | Valkey cache (Redis-compatible) | âœ… CrÃ­tico |

---

### Microservices Core (08, 11-15)

| Archivo | Recursos | PropÃ³sito | Estado | Replicas |
|---------|----------|-----------|--------|----------|
| `08-context-service.yaml` | Deployment + 2 Services | Context assembly | âœ… ProducciÃ³n | 2 |
| `11-orchestrator-service.yaml` | Deployment + Service + ConfigMap | Multi-agent orchestrator | âœ… ProducciÃ³n | 2 |
| `11a-orchestrator-delete-councils.yaml` | Job | Limpia councils | âš ï¸  Utility |
| `11b-orchestrator-init-councils.yaml` | Job | Inicializa councils | âš ï¸  Utility |
| `12-planning-service.yaml` | Deployment + Service | Story FSM | âœ… ProducciÃ³n | 2 |
| `12-deliberation-trigger-job.yaml` | Job | Trigger deliberations | âš ï¸  Debug tool |
| `14-ray-executor.yaml` | Deployment + Service | GPU task execution | âœ… ProducciÃ³n | 1 |
| `15-workflow-service.yaml` | Deployment + Service | Workflow FSM (RBAC L2) | âœ… ProducciÃ³n | 2 |
| `15-nats-streams-init.yaml` | Job | Initialize NATS streams | âœ… CrÃ­tico (setup) | - |

---

### Monitoring & Observability (13, 30-32)

| Archivo | Recursos | PropÃ³sito | Estado | Replicas |
|---------|----------|-----------|--------|----------|
| `13-monitoring-dashboard.yaml` | Deployment + Service + Ingress | System health UI | âœ… ProducciÃ³n | 1 |
| `30-grafana.yaml` | Secret + Deployment + Service | Grafana dashboards | âœ… ProducciÃ³n | 1 |
| `31-grafana-ingress.yaml` | Ingress | Grafana exposure | âœ… Necesario | - |
| `32-loki.yaml` | ConfigMap + Deployment + Service | Log aggregation | âœ… ProducciÃ³n | 1 |

---

### Debug Tools: GrpcUI (13a-14f)

**13 archivos** para herramienta de debug:

| Archivo | PropÃ³sito | Estado |
|---------|-----------|--------|
| `13a-proto-docs-deployment.yaml` | Proto docs server | âœ… Debug tool |
| `13b-proto-docs-service.yaml` | Service | âœ… Debug tool |
| `13c-proto-docs-ingress.yaml` | Ingress | âœ… Debug tool |
| `14a-grpcui-deployment.yaml` | GrpcUI "generic"? | âš ï¸  Unclear |
| `14b-grpcui-service.yaml` | Service | âš ï¸  Unclear |
| `14c-grpcui-ingress.yaml` | Ingress | âš ï¸  Unclear |
| `14d-grpcui-context-deployment.yaml` | GrpcUI for context | âœ… Debug tool |
| `14d-grpcui-orchestrator-deployment.yaml` | GrpcUI for orchestrator | âœ… Debug tool |
| `14d-grpcui-ray_executor-deployment.yaml` | GrpcUI for ray_executor | âœ… Debug tool |
| `14e-grpcui-context-service.yaml` | Service | âœ… Debug tool |
| `14e-grpcui-orchestrator-service.yaml` | Service | âœ… Debug tool |
| `14e-grpcui-ray_executor-service.yaml` | Service | âœ… Debug tool |
| `14f-grpcui-context-ingress.yaml` | Ingress | âœ… Debug tool |
| `14f-grpcui-orchestrator-ingress.yaml` | Ingress | âœ… Debug tool |
| `14f-grpcui-ray_executor-ingress.yaml` | Ingress | âœ… Debug tool |

**Problema**: DeberÃ­an consolidarse en directorio `debug/` o `grpcui/`

---

### Sin NumeraciÃ³n

| Archivo | Recursos | PropÃ³sito | Estado |
|---------|----------|-----------|--------|
| `vllm-server.yaml` | Deployment + Service + PVC | vLLM model serving | âœ… ProducciÃ³n | 3 |

**Problema**: Â¿Por quÃ© no tiene nÃºmero? DeberÃ­a ser `16-vllm-server.yaml`

---

## ğŸ¯ **ORDEN DE APLICACIÃ“N CORRECTO**

Basado en dependencias:

```bash
# 1. Foundation
kubectl apply -f 00-namespace.yaml
kubectl apply -f 00-configmaps.yaml
kubectl apply -f 01-secrets.yaml

# 2. Infrastructure
kubectl apply -f 01-nats.yaml
kubectl apply -f 02-nats-internal-dns.yaml
kubectl apply -f 09-neo4j.yaml
kubectl apply -f 10-valkey.yaml
kubectl apply -f 07-registry.yaml  # Container registry

# 3. Wait for infra ready
kubectl wait --for=condition=ready pod -l app=nats -n swe-ai-fleet --timeout=120s
kubectl wait --for=condition=ready pod -l app=neo4j -n swe-ai-fleet --timeout=120s
kubectl wait --for=condition=ready pod -l app=valkey -n swe-ai-fleet --timeout=120s

# 4. NATS Streams
kubectl apply -f 15-nats-streams-init.yaml
kubectl wait --for=condition=complete job/nats-streams-init -n swe-ai-fleet --timeout=60s

# 5. Core Microservices
kubectl apply -f 08-context-service.yaml
kubectl apply -f 11-orchestrator-service.yaml
kubectl apply -f 12-planning-service.yaml
kubectl apply -f 14-ray-executor.yaml
kubectl apply -f 15-workflow-service.yaml
kubectl apply -f vllm-server.yaml

# 6. Monitoring
kubectl apply -f 13-monitoring-dashboard.yaml
kubectl apply -f 30-grafana.yaml
kubectl apply -f 32-loki.yaml

# 7. Ingresses & Exposure
kubectl apply -f 05-ui-ingress.yaml
kubectl apply -f 06-ray-dashboard-ingress.yaml
kubectl apply -f 31-grafana-ingress.yaml

# 8. Debug Tools (optional)
kubectl apply -f 13a-proto-docs-deployment.yaml
kubectl apply -f 13b-proto-docs-service.yaml
kubectl apply -f 13c-proto-docs-ingress.yaml
# GrpcUI files...
```

---

## ğŸ“¦ **PROPUESTA DE REORGANIZACIÃ“N**

### Estructura Nueva

```
deploy/k8s/
â”œâ”€â”€ 00-foundation/
â”‚   â”œâ”€â”€ 00-namespace.yaml
â”‚   â”œâ”€â”€ 01-configmaps.yaml
â”‚   â””â”€â”€ 02-secrets.yaml            # Renombrado de 01-secrets
â”‚
â”œâ”€â”€ 10-infrastructure/
â”‚   â”œâ”€â”€ 10-nats.yaml
â”‚   â”œâ”€â”€ 11-nats-internal-dns.yaml
â”‚   â”œâ”€â”€ 12-neo4j.yaml
â”‚   â”œâ”€â”€ 13-valkey.yaml
â”‚   â””â”€â”€ 14-container-registry.yaml  # Renombrado de 07-registry
â”‚
â”œâ”€â”€ 20-streams/
â”‚   â””â”€â”€ 20-nats-streams-init.yaml
â”‚
â”œâ”€â”€ 30-microservices/
â”‚   â”œâ”€â”€ 30-context.yaml
â”‚   â”œâ”€â”€ 31-orchestrator.yaml
â”‚   â”œâ”€â”€ 32-planning.yaml
â”‚   â”œâ”€â”€ 33-workflow.yaml
â”‚   â”œâ”€â”€ 34-ray-executor.yaml
â”‚   â””â”€â”€ 35-vllm-server.yaml
â”‚
â”œâ”€â”€ 40-monitoring/
â”‚   â”œâ”€â”€ 40-monitoring-dashboard.yaml
â”‚   â”œâ”€â”€ 41-grafana.yaml
â”‚   â””â”€â”€ 42-loki.yaml
â”‚
â”œâ”€â”€ 50-ingress/
â”‚   â”œâ”€â”€ 50-ui-ingress.yaml
â”‚   â”œâ”€â”€ 51-ray-dashboard-ingress.yaml
â”‚   â”œâ”€â”€ 52-grafana-ingress.yaml
â”‚   â””â”€â”€ 53-monitoring-ingress.yaml
â”‚
â”œâ”€â”€ 90-debug/
â”‚   â”œâ”€â”€ proto-docs/
â”‚   â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”‚   â”œâ”€â”€ service.yaml
â”‚   â”‚   â””â”€â”€ ingress.yaml
â”‚   â””â”€â”€ grpcui/
â”‚       â”œâ”€â”€ context/
â”‚       â”‚   â”œâ”€â”€ deployment.yaml
â”‚       â”‚   â”œâ”€â”€ service.yaml
â”‚       â”‚   â””â”€â”€ ingress.yaml
â”‚       â”œâ”€â”€ orchestrator/
â”‚       â”‚   â”œâ”€â”€ deployment.yaml
â”‚       â”‚   â”œâ”€â”€ service.yaml
â”‚       â”‚   â””â”€â”€ ingress.yaml
â”‚       â””â”€â”€ ray-executor/
â”‚           â”œâ”€â”€ deployment.yaml
â”‚           â”œâ”€â”€ service.yaml
â”‚           â””â”€â”€ ingress.yaml
â”‚
â””â”€â”€ 99-jobs/
    â”œâ”€â”€ nats-delete-streams.yaml
    â”œâ”€â”€ orchestrator-delete-councils.yaml
    â”œâ”€â”€ orchestrator-init-councils.yaml
    â””â”€â”€ deliberation-trigger.yaml
```

### Beneficios

1. **Claridad**: JerarquÃ­a visual de directorios
2. **Orden lÃ³gico**: NumeraciÃ³n 00-90 con gaps intencionales
3. **Aislamiento**: Debug tools separados de producciÃ³n
4. **Escalabilidad**: FÃ¡cil aÃ±adir nuevos servicios
5. **Mantenibilidad**: Un servicio = un archivo (o subdirectorio)

---

## âš ï¸ **ARCHIVOS A DEPRECAR/ELIMINAR**

### Candidatos para EliminaciÃ³n

| Archivo | RazÃ³n | AcciÃ³n |
|---------|-------|--------|
| `03-configmaps.yaml` | Posible duplicado de 00-configmaps | Verificar contenido â†’ Eliminar si duplicado |
| `04-services.yaml` | Frankenstein file con servicios legacy | Eliminar (ya existen individuales) |
| `07-neo4j-secret.yaml` | Duplica 01-secrets.yaml | Eliminar (usar 01-secrets Ãºnicamente) |
| `12-deliberation-trigger-job.yaml` | Debug job, no producciÃ³n | Mover a `99-jobs/` |

### Candidatos para Mover

| Archivo | Destino | RazÃ³n |
|---------|---------|-------|
| `02a-nats-delete-streams.yaml` | `99-jobs/` | Utility job |
| `11a-orchestrator-delete-councils.yaml` | `99-jobs/` | Utility job |
| `11b-orchestrator-init-councils.yaml` | `99-jobs/` | Utility job |
| Todos los `14*-grpcui-*.yaml` | `90-debug/grpcui/` | Debug tools |
| `13*-proto-docs-*.yaml` | `90-debug/proto-docs/` | Debug tool |

---

## ğŸ” **REGISTRY NAMESPACE: DECISIÃ“N REQUERIDA**

### OpciÃ³n A: Unificar a `swe-ai-fleet` (RECOMENDADO)

**Pros**:
- Align with K8s namespace (`swe-ai-fleet`)
- `fresh-redeploy.sh` ya usa este namespace
- Coherencia semÃ¡ntica (namespace K8s = namespace registry)

**Contras**:
- Requiere cambiar 13 imÃ¡genes en YAMLs

**Esfuerzo**: 1 hora (buscar/reemplazar global)

---

### OpciÃ³n B: Unificar a `swe-fleet`

**Pros**:
- MayorÃ­a de imÃ¡genes ya usan este namespace (13/16)
- Menos cambios en YAMLs

**Contras**:
- Desalineado con K8s namespace
- Requiere cambiar `fresh-redeploy.sh`
- Nombre mÃ¡s corto pero menos descriptivo

**Esfuerzo**: 30 minutos

---

### RecomendaciÃ³n Final

âœ… **OpciÃ³n A: `swe-ai-fleet`**

**RazÃ³n**: El namespace K8s es `swe-ai-fleet`, el registry namespace deberÃ­a ser el mismo para evitar confusiÃ³n.

---

## ğŸ“Š **SIGUIENTE STEPS**

### Fase 1: AuditorÃ­a Completada âœ…
- [x] Inventario completo de archivos
- [x] IdentificaciÃ³n de problemas
- [x] Propuesta de reorganizaciÃ³n

### Fase 2: Decisiones ArquitectÃ³nicas
- [ ] Decidir registry namespace (`swe-ai-fleet` vs `swe-fleet`)
- [ ] Verificar `03-configmaps.yaml` y `07-neo4j-secret.yaml` (duplicados?)
- [ ] Confirmar servicios obsoletos en `04-services.yaml`

### Fase 3: ReorganizaciÃ³n (prÃ³xima historia)
- [ ] Crear nueva estructura de directorios
- [ ] Migrar archivos a nueva estructura
- [ ] Actualizar `fresh-redeploy.sh` con nuevos paths
- [ ] Actualizar scripts de deploy
- [ ] Testing completo

---

## ğŸ¯ **MÃ‰TRICAS DE Ã‰XITO**

Post-reorganizaciÃ³n:

- âœ… Un directorio por capa (foundation, infrastructure, microservices, etc.)
- âœ… NumeraciÃ³n lÃ³gica con gaps intencionales (00-90)
- âœ… Debug tools separados de producciÃ³n
- âœ… Registry namespace unificado
- âœ… Cero archivos duplicados
- âœ… DocumentaciÃ³n clara del orden de aplicaciÃ³n

---

---

## ğŸ“š **AUDITORÃA DE DOCUMENTACIÃ“N**

### Estado de la DocumentaciÃ³n

**Total**: 21 archivos de documentaciÃ³n relacionados con deploy/infrastructure

| CategorÃ­a | Archivos | LÃ­neas Totales | Estado |
|-----------|----------|----------------|--------|
| Getting Started | 3 | 1,225 | âœ… Actualizado |
| Infrastructure | 7 | 2,531 | âš ï¸  Mix CRI-O/K8s |
| Operations | 3 | 903 | âš ï¸  Parcial |
| Deploy-specific | 3 | 684 | âš ï¸  Obsoleto parcial |
| Installation | 1 | 178 | âš ï¸  CRI-O legacy |
| Architecture | 2 | 218 | âœ… OK |

---

### ğŸ“ Inventario Completo

#### Getting Started (âœ… ACTUALIZADO)
- `docs/getting-started/README.md` (14K, 421 lines)
- `docs/getting-started/quickstart.md` (11K, 368 lines)
- `docs/getting-started/prerequisites.md` (3.4K, 123 lines)

**Calidad**: Alta, actualizado recientemente (7 nov 2024)
**Referencias a**: `fresh-redeploy.sh` âœ…

---

#### Infrastructure (âš ï¸ MIX CRI-O/K8S)
- `docs/infrastructure/INSTALL_K8S_CRIO_GPU.md` (20K, 653 lines)
- `docs/infrastructure/PODMAN_CRIO_GUIDE.md` (9.8K, 313 lines)
- `docs/infrastructure/RAYCLUSTER_INTEGRATION.md` (7.8K, 251 lines)
- `docs/infrastructure/RAY_STANDALONE.md` (9.9K, 324 lines)
- `docs/infrastructure/GPU_TIME_SLICING.md` (7.9K, 254 lines)
- `docs/infrastructure/CONTAINER_RUNTIMES.md` (9.2K, 293 lines)
- `docs/infrastructure/INSTALL_CRIO.md` (4.9K, 157 lines)

**Problema**: Mezcla docs de CRI-O standalone (legacy) con Kubernetes (actual)

**CRI-O Standalone** (âš ï¸ OBSOLETO):
- Referencias a `deploy/crio/*.json` (pods sin K8s)
- Scripts `scripts/vllm_crio.sh`
- `crictl runp` manual commands

**Kubernetes** (âœ… ACTUAL):
- INSTALL_K8S_CRIO_GPU.md es correcto (K8s + CRI-O)
- GPU_TIME_SLICING.md aplicable
- RAYCLUSTER_INTEGRATION.md aplicable

**RecomendaciÃ³n**: Archivar docs CRI-O standalone a `docs/archived/cri-o-standalone/`

---

#### Operations (âš ï¸ PARCIALMENTE ACTUALIZADO)
- `docs/operations/DEPLOYMENT.md` (16K, 552 lines) - **Ãšltima actualizaciÃ³n: 7 nov 2024**
- `docs/operations/K8S_TROUBLESHOOTING.md` (6.4K, 202 lines) - **24 oct 2024**
- `docs/operations/TROUBLESHOOTING_CRIO.md` (2.5K, 82 lines)

**DEPLOYMENT.md Analysis**:
```markdown
# Contenido (parcial):
- Deployment flow con fresh-redeploy.sh âœ…
- Update procedure âœ…
- Rollback strategies â“ (verificar si estÃ¡)
- Monitoring deployment health â“
```

**Gaps Detectados**:
- âŒ No menciona nuevo `01-secrets.yaml`
- âŒ No documenta fixes recientes (paths YAML corregidos)
- âŒ No menciona registry namespace inconsistency
- âš ï¸  K8S_TROUBLESHOOTING.md bien pero podrÃ­a referenciar AUDIT

---

#### Deploy-Specific (âš ï¸ PARCIALMENTE OBSOLETO)
- `deploy/k8s/README.md` (113 lines)
- `deploy/k8s/CONTEXT_DEPLOYMENT.md` (319 lines)
- `deploy/crio/README.md` (59 lines)
- `scripts/infra/README.md` (252 lines)

**deploy/k8s/README.md** (âš ï¸ REVISAR):
```bash
# Contenido actual desconocido - necesita verificaciÃ³n
# Â¿Documenta numeraciÃ³n de archivos?
# Â¿Menciona orden de aplicaciÃ³n?
```

**deploy/k8s/CONTEXT_DEPLOYMENT.md** (319 lines):
- EspecÃ­fico para Context Service
- âš ï¸  Â¿Actualizado con nuevos paths?

**deploy/crio/README.md** (59 lines):
- âš ï¸  CRI-O standalone (legacy)
- DeberÃ­a estar archivado

**scripts/infra/README.md** (252 lines):
- âš ï¸  Â¿Documenta fresh-redeploy.sh actualizado?
- âŒ No menciona fixes del 2025-11-08

---

#### Installation & Architecture
- `docs/INSTALLATION.md` (178 lines) - âš ï¸  CRI-O-focused, legacy
- `docs/INFRA_ARCHITECTURE.md` (123 lines) - âš ï¸  "CRI-O now; Kubernetes next"
- `docs/GOLDEN_PATH.md` (95 lines) - âœ… OK

**INSTALLATION.md Issues**:
```markdown
Line 3: "using CRI-O, plus optional steps for Ray and Kubernetes"
```
âŒ **OBSOLETO**: K8s ya NO es opcional, es el deployment method actual

**INFRA_ARCHITECTURE.md Issues**:
```markdown
Title: "Infrastructure Architecture (CRIâ€‘O now; Kubernetes next)"
Line 17: "Infrastructure with CRIâ€‘O (current phase)"
```
âŒ **OBSOLETO**: Kubernetes ES la fase actual, no "next"

---

### ğŸ” **GAPS EN DOCUMENTACIÃ“N**

#### Gap #1: No Existe GuÃ­a de ReorganizaciÃ³n de deploy/
- âŒ No hay doc de cÃ³mo reorganizar `deploy/k8s/`
- âŒ No hay estÃ¡ndares de numeraciÃ³n documentados
- âŒ No hay guÃ­a de "cuÃ¡ndo crear nuevo archivo vs reusar existente"

#### Gap #2: Registry Namespace No Documentado
- âŒ Nadie documenta que hay dos namespaces (`swe-fleet` vs `swe-ai-fleet`)
- âŒ No hay decisiÃ³n arquitectÃ³nica registrada
- âŒ No hay ADR (Architecture Decision Record)

#### Gap #3: fresh-redeploy.sh No Tiene Docs Completas
- âš ï¸  Mencionado en varios lugares pero sin deep-dive
- âŒ No documenta flags `--skip-build`, `--reset-nats`
- âŒ No documenta troubleshooting de build failures
- âœ… **NUEVO**: `scripts/infra/FRESH_REDEPLOY_FIXES.md` (creado hoy)

#### Gap #4: Secrets Management
- âœ… **NUEVO**: `deploy/k8s/SECRETS_README.md` (creado hoy)
- âŒ No integrado en docs principales
- âŒ No referenciado desde INSTALLATION.md

#### Gap #5: Orden de AplicaciÃ³n de YAMLs
- âŒ No hay doc oficial del orden correcto
- âš ï¸  EstÃ¡ en este AUDIT pero deberÃ­a estar en `deploy/k8s/README.md`

#### Gap #6: Debug Tools (grpcui, proto-docs)
- âŒ No documentado cuÃ¡ndo/cÃ³mo usar grpcui
- âŒ No claro si son producciÃ³n o debug-only
- âŒ No hay guÃ­a de "developer tools"

---

### ğŸ“Š **ANÃLISIS DE REFERENCIAS**

#### Referencias a `fresh-redeploy.sh`

**Encontradas en**:
1. `docs/getting-started/quickstart.md` âœ…
2. `docs/getting-started/README.md` âœ…
3. `docs/operations/DEPLOYMENT.md` âœ… (probablemente)
4. `docs/RBAC_READY_FOR_MERGE_AND_DEPLOY.md` âœ…
5. Scripts mencionan pero no documentan en profundidad

**Problemas**:
- âŒ No todas las referencias mencionan flags
- âŒ No documentan quÃ© hace cada step
- âŒ No mencionan fixes del 2025-11-08

---

#### Referencias a `deploy/crio/` (LEGACY)

**Encontradas en**:
- `docs/infrastructure/CONTAINER_RUNTIMES.md`
- `docs/infrastructure/PODMAN_CRIO_GUIDE.md`
- `docs/INFRA_ARCHITECTURE.md`
- `deploy/crio/README.md`

**AcciÃ³n Requerida**:
- âš ï¸  Archivar a `docs/archived/cri-o-standalone/`
- âš ï¸  AÃ±adir deprecation notice
- âš ï¸  Redirect readers a K8s docs

---

### ğŸ”´ **INCONSISTENCIAS CRÃTICAS**

#### Inconsistencia #1: "CRI-O is current, K8s is next"
**DocumentaciÃ³n dice**:
```
INFRA_ARCHITECTURE.md: "Infrastructure with CRIâ€‘O (current phase)"
INSTALLATION.md: "CRI-O runtime... optional: kubectl, kind for K8s"
```

**Realidad**:
- âœ… Cluster K8s en producciÃ³n desde hace 23 dÃ­as
- âœ… 30+ pods corriendo en `swe-ai-fleet` namespace
- âœ… Scripts usan `kubectl`, no `crictl`
- âŒ CRI-O standalone **ya no se usa**

**Fix Required**: Actualizar ambos docs para reflejar "K8s is current"

---

#### Inconsistencia #2: Servicios en DEPLOYMENT.md vs Realidad

**Â¿QuÃ© servicios documenta DEPLOYMENT.md?** (necesita verificaciÃ³n)

**Servicios en ProducciÃ³n** (segÃºn `kubectl get pods`):
```
âœ… orchestrator (2 replicas)
âœ… context (2 replicas)
âœ… planning (2 replicas)
âœ… workflow (2 replicas)
âœ… ray-executor (1 replica)
âœ… monitoring-dashboard (1 replica)
âœ… vllm-server (3 replicas)
âœ… grafana, loki, neo4j, valkey, nats
```

**Servicios en `04-services.yaml`**:
```
â“ planning (duplicado de 12-planning?)
â“ storycoach (Â¿en producciÃ³n?)
â“ workspace (Â¿en producciÃ³n?)
â“ po-ui (Â¿actualizado?)
```

**AcciÃ³n**: Verificar si DEPLOYMENT.md documenta servicios legacy

---

### âœ… **DOCUMENTACIÃ“N BIEN HECHA**

#### Lo Que EstÃ¡ Correcto

1. **Getting Started** (docs/getting-started/)
   - âœ… Actualizado recientemente (7 nov 2024)
   - âœ… Menciona `fresh-redeploy.sh`
   - âœ… Prerequisites claros

2. **K8S_TROUBLESHOOTING.md**
   - âœ… Exhaustivo (202 lines)
   - âœ… Issue F (ContainerStatusUnknown) documentado
   - âœ… Policy de 120s timeouts documentado

3. **GPU_TIME_SLICING.md**
   - âœ… TÃ©cnico y preciso
   - âœ… Aplicable a producciÃ³n actual

4. **RAYCLUSTER_INTEGRATION.md**
   - âœ… Ray cluster deployment bien explicado

5. **GOLDEN_PATH.md**
   - âœ… Happy path development workflow

---

### ğŸ“ **PROPUESTA DE REORGANIZACIÃ“N DOCUMENTAL**

#### Nueva Estructura

```
docs/
â”œâ”€â”€ getting-started/           [âœ… OK - mantener]
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ prerequisites.md
â”‚   â””â”€â”€ quickstart.md
â”‚
â”œâ”€â”€ infrastructure/            [âš ï¸ REFACTOR]
â”‚   â”œâ”€â”€ README.md             [NUEVO - Ã­ndice]
â”‚   â”œâ”€â”€ kubernetes/           [NUEVO - separar K8s]
â”‚   â”‚   â”œâ”€â”€ cluster-setup.md
â”‚   â”‚   â”œâ”€â”€ gpu-time-slicing.md
â”‚   â”‚   â””â”€â”€ raycluster-integration.md
â”‚   â”œâ”€â”€ container-runtime.md  [Renombrado, K8s-focused]
â”‚   â””â”€â”€ archived/             [NUEVO]
â”‚       â””â”€â”€ cri-o-standalone/ [Mover docs legacy]
â”‚
â”œâ”€â”€ deployment/               [NUEVO - Deploy-focused]
â”‚   â”œâ”€â”€ README.md            [GuÃ­a principal]
â”‚   â”œâ”€â”€ quick-deploy.md      [fresh-redeploy.sh usage]
â”‚   â”œâ”€â”€ manual-deploy.md     [kubectl apply paso a paso]
â”‚   â”œâ”€â”€ secrets-management.md [Link a deploy/k8s/SECRETS_README.md]
â”‚   â”œâ”€â”€ troubleshooting.md   [Consolidar K8S_TROUBLESHOOTING.md]
â”‚   â””â”€â”€ rollback.md          [Rollback strategies]
â”‚
â”œâ”€â”€ operations/              [âš ï¸ REFACTOR]
â”‚   â”œâ”€â”€ monitoring.md        [Observability]
â”‚   â”œâ”€â”€ backup-restore.md    [NUEVO]
â”‚   â””â”€â”€ disaster-recovery.md [NUEVO]
â”‚
â”œâ”€â”€ architecture/            [âœ… OK - mantener]
â”‚   â””â”€â”€ decisions/          [ADRs]
â”‚       â””â”€â”€ ADR-001-registry-namespace.md [NUEVO]
â”‚
â””â”€â”€ reference/              [âœ… OK - mantener]
    â”œâ”€â”€ deploy-file-naming.md    [NUEVO - estÃ¡ndares]
    â”œâ”€â”€ yaml-organization.md     [NUEVO - cÃ³mo organizar]
    â””â”€â”€ developer-tools.md       [NUEVO - grpcui, proto-docs]
```

---

### ğŸ¯ **ACCIONES REQUERIDAS (DocumentaciÃ³n)**

#### Prioridad CRÃTICA (P0)
1. âŒ Actualizar `docs/INFRA_ARCHITECTURE.md`: K8s is current, not "next"
2. âŒ Actualizar `docs/INSTALLATION.md`: K8s is primary, not optional
3. âŒ Crear `docs/architecture/decisions/ADR-001-registry-namespace.md`
4. âŒ Actualizar `docs/operations/DEPLOYMENT.md` con fixes del 2025-11-08

#### Prioridad ALTA (P1)
5. âš ï¸  Crear `docs/deployment/README.md` como guÃ­a central
6. âš ï¸  Documentar orden de aplicaciÃ³n de YAMLs
7. âš ï¸  Integrar `deploy/k8s/SECRETS_README.md` en docs/
8. âš ï¸  Archivar docs de CRI-O standalone

#### Prioridad MEDIA (P2)
9. âš ï¸  Crear guÃ­a de developer tools (grpcui, proto-docs)
10. âš ï¸  Crear ADR para numeraciÃ³n de archivos deploy/k8s/
11. âš ï¸  Actualizar `scripts/infra/README.md` con fixes

#### Prioridad BAJA (P3)
12. âš ï¸  Reorganizar estructura de docs/ (propuesta arriba)
13. âš ï¸  Crear Ã­ndice visual (mermaid diagram) de docs
14. âš ï¸  Traducir docs crÃ­ticos a espaÃ±ol?

---

### ğŸ“ˆ **MÃ‰TRICAS DE CALIDAD DOCUMENTAL**

| MÃ©trica | Actual | Objetivo | Gap |
|---------|--------|----------|-----|
| Docs actualizados (< 1 mes) | 40% (8/21) | 80% | âŒ 40% |
| Referencias correctas | 60% | 95% | âŒ 35% |
| Docs con ejemplos funcionales | 70% | 90% | âš ï¸  20% |
| Coverage de troubleshooting | 75% | 90% | âš ï¸  15% |
| ADRs documentados | 0 | 5 | âŒ 100% |
| Docs obsoletos archivados | 0% | 100% | âŒ 100% |

---

### ğŸ’¡ **RECOMENDACIONES**

1. **Crear Documentation Sprint**
   - 2-3 dÃ­as dedicados a actualizar docs crÃ­ticos
   - Priorizar P0 y P1

2. **Implementar Doc Review Policy**
   - Todo PR que cambie infra debe actualizar docs
   - CI check: Â¿docs actualizados?

3. **Versionar DocumentaciÃ³n**
   - Docs por versiÃ³n del sistema
   - Deprecation notices claros

4. **Crear Docs Dashboard**
   - README con status de cada doc
   - Ãšltima actualizaciÃ³n
   - Responsable/owner

5. **ADR Process**
   - Decisiones arquitectÃ³nicas como ADRs
   - Template: problema, contexto, decisiÃ³n, consecuencias

---

---

## ğŸ§¹ **CONTENIDO OBSOLETO A LIMPIAR**

### ğŸ”´ **Prioridad CRÃTICA - Eliminar Antes de ReorganizaciÃ³n**

#### CÃ³digo Obsoleto

| Tipo | UbicaciÃ³n | RazÃ³n | AcciÃ³n |
|------|-----------|-------|--------|
| **Old pod naming** | `planning-7c64db55c5-z2cgh` | Pod zombie del deploy fallido 185739 | `kubectl delete pod -n swe-ai-fleet planning-7c64db55c5-z2cgh` |
| **vllm pods** | ContainerStatusUnknown (3 pods) | DespuÃ©s de reinicio de nodo | Scale to 0 â†’ Scale to 3 |
| **Old ReplicaSets** | MÃºltiples namespaces | ReplicaSets de deploys anteriores | `kubectl delete rs --cascade=orphan` (con cuidado) |

#### Archivos a Eliminar/Archivar

**Deploy Files** (ğŸ”´ ELIMINAR):
```bash
# Duplicados confirmados
deploy/k8s/04-services.yaml           # Frankenstein file (servicios legacy)
deploy/k8s/07-neo4j-secret.yaml       # Duplica 01-secrets.yaml

# A verificar antes de eliminar
deploy/k8s/03-configmaps.yaml         # Â¿Duplica 00-configmaps.yaml?
```

**CRI-O Standalone** (âš ï¸ ARCHIVAR):
```bash
# Mover a docs/archived/cri-o-standalone/
deploy/crio/
docs/infrastructure/PODMAN_CRIO_GUIDE.md (secciones standalone)
docs/INFRA_ARCHITECTURE.md (actualizar, no eliminar)
```

#### ImÃ¡genes Docker/Podman Obsoletas

```bash
# Limpiar imÃ¡genes locales antiguas (liberar espacio)
podman images | grep "swe-ai-fleet" | grep -E "202511(02|04|07)" | awk '{print $3}' | xargs podman rmi

# EspecÃ­ficamente las del deploy fallido
podman rmi registry.underpassai.com/swe-ai-fleet/orchestrator:v3.0.0-20251108-185739 2>/dev/null || true
podman rmi registry.underpassai.com/swe-ai-fleet/context:v2.0.0-20251108-185739 2>/dev/null || true
podman rmi registry.underpassai.com/swe-ai-fleet/planning:v2.0.0-20251108-185739 2>/dev/null || true
```

**Estimado de espacio a liberar**: ~2-3 GB

---

### ğŸŸ¡ **Prioridad MEDIA - Limpiar Durante ReorganizaciÃ³n**

#### Archivos Legacy

| Archivo | Estado | AcciÃ³n |
|---------|--------|--------|
| `deploy/k8s/02a-nats-delete-streams.yaml` | Utility | Mover a `99-jobs/` |
| `deploy/k8s/11a-orchestrator-delete-councils.yaml` | Utility | Mover a `99-jobs/` |
| `deploy/k8s/11b-orchestrator-init-councils.yaml` | Utility | Mover a `99-jobs/` |
| `deploy/k8s/12-deliberation-trigger-job.yaml` | Debug | Mover a `99-jobs/` |

#### Tests Obsoletos

```bash
# Verificar si hay tests legacy que no corren
find tests/ -name "*legacy*" -o -name "*old*" -o -name "*deprecated*"
```

---

### ğŸ”µ **Prioridad BAJA - Limpieza Continua**

#### Logs y Temporales

```bash
# Limpiar logs de build
rm -f /tmp/swe-ai-fleet-build-*.log

# Limpiar pytest cache
find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null

# Limpiar __pycache__
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null

# Limpiar Ruff cache
rm -rf .ruff_cache/
```

#### Git Cleanup

```bash
# Limpiar branches merged
git branch --merged | grep -v "main\|master\|develop" | xargs git branch -d

# Limpiar remote-tracking branches eliminadas
git remote prune origin

# GC y optimizaciÃ³n
git gc --aggressive --prune=now
```

---

### ğŸ“‹ **CHECKLIST DE LIMPIEZA PRE-REORGANIZACIÃ“N**

**Antes de reorganizar `deploy/k8s/`**:

- [ ] **Eliminar planning pod zombie** (`planning-7c64db55c5-z2cgh`)
- [ ] **Limpiar vllm-server pods** (ContainerStatusUnknown)
- [ ] **Verificar `03-configmaps.yaml`** - Â¿es duplicado?
- [ ] **Verificar `07-neo4j-secret.yaml`** - Â¿es duplicado?
- [ ] **Backup de `04-services.yaml`** antes de eliminar
- [ ] **Archivar docs CRI-O standalone** a `docs/archived/`
- [ ] **Limpiar imÃ¡genes locales antiguas** (liberar ~3GB)
- [ ] **Correr tests** antes de deploy del refactor
- [ ] **Verificar logs** de servicios actuales

**Durante reorganizaciÃ³n**:

- [ ] **Mover utility jobs** a `99-jobs/`
- [ ] **Separar grpcui** a `90-debug/grpcui/`
- [ ] **Crear directorios** nuevos (`00-foundation/`, etc.)
- [ ] **Actualizar scripts** de deploy con nuevos paths

**DespuÃ©s de reorganizaciÃ³n**:

- [ ] **Verificar que todo funciona** con nueva estructura
- [ ] **Actualizar documentaciÃ³n** con nuevos paths
- [ ] **Commit de reorganizaciÃ³n** con mensaje claro
- [ ] **Tag de versiÃ³n** (e.g., `v1.0.0-deploy-reorganized`)

---

### âš ï¸ **PRECAUCIONES**

1. **NUNCA eliminar sin backup**:
   ```bash
   # Antes de eliminar 04-services.yaml:
   cp deploy/k8s/04-services.yaml .skip/backup-04-services-$(date +%Y%m%d).yaml
   ```

2. **Verificar que servicios NO estÃ¡n en producciÃ³n**:
   ```bash
   # Antes de eliminar servicios de 04-services.yaml
   kubectl get pods -n swe-ai-fleet | grep -E "storycoach|workspace"
   ```

3. **Guardar evidencia de limpieza**:
   ```bash
   # Log de lo que se eliminÃ³
   echo "$(date): Eliminado 04-services.yaml (legacy)" >> .skip/CLEANUP_LOG.txt
   ```

---

### ğŸ¯ **SCRIPT DE LIMPIEZA AUTOMÃTICA**

```bash
#!/bin/bash
# cleanup-obsolete.sh - Limpieza segura de contenido obsoleto

set -e

NAMESPACE="swe-ai-fleet"
BACKUP_DIR=".skip/backup-$(date +%Y%m%d-%H%M%S)"

mkdir -p "$BACKUP_DIR"

echo "ğŸ§¹ Iniciando limpieza de contenido obsoleto..."

# 1. Backup de archivos a eliminar
echo "ğŸ“¦ Backup de archivos..."
cp deploy/k8s/04-services.yaml "$BACKUP_DIR/" 2>/dev/null || true
cp deploy/k8s/07-neo4j-secret.yaml "$BACKUP_DIR/" 2>/dev/null || true

# 2. Limpiar pods zombie
echo "ğŸ—‘ï¸  Limpiando pods zombie..."
kubectl delete pod planning-7c64db55c5-z2cgh -n $NAMESPACE 2>/dev/null || echo "  Ya eliminado"

# 3. Limpiar vllm-server
echo "ğŸ”„ Reiniciando vllm-server..."
kubectl scale deployment/vllm-server -n $NAMESPACE --replicas=0
sleep 5
kubectl scale deployment/vllm-server -n $NAMESPACE --replicas=3

# 4. Limpiar imÃ¡genes locales antiguas
echo "ğŸ³ Limpiando imÃ¡genes Docker antiguas..."
podman images | grep "swe-ai-fleet.*185739" | awk '{print $3}' | xargs -r podman rmi 2>/dev/null || true

# 5. Limpiar caches Python
echo "ğŸ Limpiando caches Python..."
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true

# 6. Git cleanup
echo "ğŸŒ³ Git cleanup..."
git gc --quiet

echo "âœ… Limpieza completada. Backup en: $BACKUP_DIR"
```

---

**Auditor**: AI Assistant
**Fecha**: 2025-11-08
**Cluster**: wrx80-node1 (Kubernetes v1.34.1)
**Namespace**: swe-ai-fleet

